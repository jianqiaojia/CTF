# CTFé€†å‘é¢˜è§£é¢˜æŠ¥å‘Š - VMè™šæ‹ŸæœºåŠ å¯†æŒ‘æˆ˜

## é¢˜ç›®ä¿¡æ¯

- **éš¾åº¦**: â­â­â­â­ (4/10)
- **ç±»åˆ«**: è™šæ‹Ÿæœºé€†å‘ + é“¾å¼XORåŠ å¯†
- **æ¥æº**: UNCTF
- **æ–‡ä»¶**: `vm`
- **æ¶æ„**: x64 ELF
- **ä¸»è¦æŠ€æœ¯**: è‡ªå®šä¹‰VMæŒ‡ä»¤é›†ã€å¯„å­˜å™¨çŠ¶æ€ä¿æŒã€é“¾å¼ä¾èµ–åŠ å¯†

---

## è§£é¢˜æ€è·¯

### ç¬¬ä¸€æ­¥ï¼šåˆæ­¥åˆ†æ - å‘ç°VMç»“æ„

ä½¿ç”¨IDA Proæ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé¦–å…ˆæŸ¥çœ‹ [`main`](vm:0x400b10) å‡½æ•°ï¼š

```c
__int64 __fastcall main(int a1, char **a2, char **a3)
{
  unsigned int (__fastcall ***v3)(_QWORD, void *, void *, char *); // rbx
  char s[96]; // [rsp+10h] [rbp-80h] BYREF
  
  // åˆ›å»ºVMå¯¹è±¡
  v3 = (unsigned int (__fastcall ***)(_QWORD, void *, void *, char *))operator new(0x28uLL);
  sub_400C1E(v3, a2);  // åˆå§‹åŒ–VM
  
  puts("please input your flag:");
  scanf("%s", s);
  
  if ( strlen(s) != 32 )
  {
    puts("The length of flag is wrong!");
    return 1LL;
  }
  
  // æ‰§è¡ŒVMï¼ŒéªŒè¯flag
  if ( (**v3)(v3, &unk_602080, &unk_6020A0, s) )
  {
    puts("Congratulations!");
    printf("The flag is UNCTF{%s}", s);
  }
  return 1LL;
}
```

**ç¬¬ä¸€ä¸ªå…³é”®å‘ç°**: 
- è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºï¼ˆVMï¼‰å®ç°ï¼
- VMå¯¹è±¡å¤§å°ä¸º `0x28` (40å­—èŠ‚)
- éœ€è¦32å­—èŠ‚çš„è¾“å…¥
- ä¼ å…¥äº†ä¸¤ä¸ªå…³é”®åœ°å€ï¼š`0x602080` å’Œ `0x6020A0`

### ç¬¬äºŒæ­¥ï¼šåˆ†æVMåˆå§‹åŒ– - ç†è§£å¯¹è±¡ç»“æ„

æŸ¥çœ‹ `sub_400C1E` å‡½æ•°ï¼ˆVMåˆå§‹åŒ–ï¼‰ï¼š

```c
__int64 __fastcall sub_400C1E(__int64 a1)
{
  *(_QWORD *)a1 = off_4010A8;      // vtable
  *(_QWORD *)(a1 + 8) = 0LL;       // PCæŒ‡é’ˆ
  *(_BYTE *)(a1 + 16) = 0;         // å¯„å­˜å™¨R0
  *(_BYTE *)(a1 + 17) = 0;         // å¯„å­˜å™¨R1  
  *(_BYTE *)(a1 + 18) = 0;         // å¯„å­˜å™¨R2
  *(_DWORD *)(a1 + 20) = 0;        // Flagå¯„å­˜å™¨
  *(_QWORD *)(a1 + 24) = 0LL;      // å­—èŠ‚ç æŒ‡é’ˆ
  *(_QWORD *)(a1 + 32) = 0LL;      // è¾“å…¥æŒ‡é’ˆ
  return a1;
}
```

**VMå¯¹è±¡ç»“æ„**ï¼ˆ40å­—èŠ‚ï¼‰ï¼š
```
åç§» 0x00 (8å­—èŠ‚): vtableæŒ‡é’ˆ
åç§» 0x08 (8å­—èŠ‚): PC (ç¨‹åºè®¡æ•°å™¨)
åç§» 0x10 (1å­—èŠ‚): å¯„å­˜å™¨R0 (å¯¹åº” a16)
åç§» 0x11 (1å­—èŠ‚): å¯„å­˜å™¨R1 (å¯¹åº” a17)
åç§» 0x12 (1å­—èŠ‚): å¯„å­˜å™¨R2 (å¾ªç¯ç´¢å¼•)
åç§» 0x14 (4å­—èŠ‚): Flag (æ¯”è¾ƒç»“æœæ ‡å¿—)
åç§» 0x18 (8å­—èŠ‚): å­—èŠ‚ç æ•°ç»„æŒ‡é’ˆ
åç§» 0x20 (8å­—èŠ‚): ç›®æ ‡å€¼æ•°ç»„æŒ‡é’ˆ
åç§» 0x28 (8å­—èŠ‚): è¾“å…¥å­—ç¬¦ä¸²æŒ‡é’ˆ
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ†æVMè°ƒåº¦å™¨ - å‘ç°æŒ‡ä»¤é›†

æŸ¥çœ‹ä¸»è°ƒåº¦å‡½æ•° [`sub_400806`](vm:0x400806)ï¼Œè¿™æ˜¯VMçš„æ ¸å¿ƒï¼š

```c
__int64 __fastcall sub_400806(__int64 a1, __int64 a2, __int64 a3, __int64 a4)
{
  *(_QWORD *)(a1 + 8) = a2 + 9;    // PCä»å­—èŠ‚ç ç¬¬9ä½å¼€å§‹
  *(_QWORD *)(a1 + 24) = a3;       // ä¿å­˜ç›®æ ‡å€¼æŒ‡é’ˆ
  *(_QWORD *)(a1 + 32) = a4;       // ä¿å­˜è¾“å…¥æŒ‡é’ˆ
  
  while ( 2 )
  {
    switch ( **(_BYTE **)(a1 + 8) )  // æ ¹æ®å½“å‰PCå¤„çš„å­—èŠ‚åˆ†å‘
    {
      case 0xA0:  // INC_R0
        (*(void (__fastcall **)(__int64))(*(_QWORD *)a1 + 8LL))(a1);
        continue;
      case 0xA1:  // INC_R1
        (*(void (__fastcall **)(__int64))(*(_QWORD *)a1 + 16LL))(a1);
        continue;
      // ... æ›´å¤šæŒ‡ä»¤ ...
    }
  }
}
```

**ç¬¬äºŒä¸ªå…³é”®å‘ç°**:
- VMä»å­—èŠ‚ç ä½ç½®9å¼€å§‹æ‰§è¡Œï¼ˆä¸æ˜¯ä»0å¼€å§‹ï¼ï¼‰
- ä½¿ç”¨ `switch-case` åˆ†å‘ä¸åŒçš„æ“ä½œç 
- æ“ä½œç èŒƒå›´æ˜¯ `0xA0` åˆ° `0xAF` (16æ¡æŒ‡ä»¤)

### ç¬¬å››æ­¥ï¼šæå–å…³é”®æ•°æ®

æŸ¥çœ‹ä¼ é€’ç»™VMçš„ä¸¤ä¸ªæ•°æ®åŒºåŸŸï¼š

**å­—èŠ‚ç æ•°ç»„ï¼ˆåœ°å€ 0x602080ï¼‰**ï¼š
```
0xA0 0xA1 0xA2 0xA3 0xA4 0xA5 0xA6 0xA7 
0xA8 0xA9 0xAA 0xAB 0xAC 0xAD 0xAE 0xAF
```
è¿™16ä¸ªå­—èŠ‚å°±æ˜¯VMçš„å®Œæ•´æŒ‡ä»¤åºåˆ—ï¼

**ç›®æ ‡å€¼æ•°ç»„ï¼ˆåœ°å€ 0x6020A0ï¼Œ32å­—èŠ‚ï¼‰**ï¼š
```
0xF4 0x0A 0xF7 0x64 0x99 0x78 0x9E 0x7D 
0xEA 0x7B 0x9E 0x7B 0x9F 0x7E 0xEB 0x71
0xE8 0x00 0xE8 0x07 0x98 0x19 0xF4 0x25 
0xF3 0x21 0xA4 0x2F 0xF4 0x2F 0xA6 0x7C
```

### ç¬¬äº”æ­¥ï¼šé€†å‘VMæŒ‡ä»¤é›†

é€šè¿‡åˆ†ævtableä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œé€ä¸ªç†è§£æ¯æ¡æŒ‡ä»¤ï¼š

| æ“ä½œç  | å‡½æ•° | åŠŸèƒ½ | PCè°ƒæ•´ |
|--------|------|------|--------|
| 0xA0 | sub_400C7C | `R0++` | 0 |
| 0xA1 | sub_400C9A | `R1++` | 0 |
| 0xA2 | sub_400CB8 | `R2++` | +11 |
| 0xA3 | sub_400CD6 | `R0 -= R2` | +2 |
| 0xA4 | sub_400CFA | `R0 ^= R1` | +7 |
| 0xA5 | sub_400D1E | `R1 ^= R0` | +1 |
| 0xA6 | sub_400D42 | `R0 = 0xCD` | -2 |
| 0xA7 | sub_400D56 | `R1 = R0` | +7 |
| 0xA8 | sub_400D70 | `R2 = 0xCD` | 0 |
| 0xA9 | sub_400D84 | `R0 = input[R2]` | -6 |
| 0xAA | sub_400DB0 | `R1 = input[R2]` | 0 |
| 0xAB | sub_400DDC | æ¯”è¾ƒ`R0`ä¸`target[R2]` | -4 |
| 0xAC | sub_400E56 | æ¯”è¾ƒ`R1`ä¸`target[R2]` | 0 |
| 0xAD | sub_400ED0 | `Flag = (R2 > 31)` | +2 |
| 0xAE | - | å¦‚æœ`Flag==0`è¿”å›å¤±è´¥ï¼Œå¦åˆ™`PC-=12` | -12 |
| 0xAF | - | å¦‚æœ`Flag==1`è¿”å›æˆåŠŸï¼Œå¦åˆ™`PC-=6` | -6 |

### ç¬¬å…­æ­¥ï¼šç¬¬ä¸€æ¬¡å°è¯• - èµ°äº†å¼¯è·¯

**é”™è¯¯å°è¯•1**: å‡è®¾æ¯ä¸ªå­—ç¬¦ç‹¬ç«‹å¤„ç†
```python
# æˆ‘æœ€åˆä»¥ä¸ºæ¯ä¸ªå­—ç¬¦çš„åŠ å¯†æ˜¯ç‹¬ç«‹çš„
for i in range(32):
    input[i] = (0xCD ^ target[i]) + i  # âŒ å¿½ç•¥äº†R1çš„çŠ¶æ€ï¼
```
**ç»“æœ**: åªæœ‰ç¬¬ä¸€ä¸ªå­—ç¬¦æ­£ç¡®ï¼Œå…¶ä»–å…¨æ˜¯ä¹±ç 

**é”™è¯¯å°è¯•2**: å¿½ç•¥PCè·³è½¬è§„å¾‹
```python
# æˆ‘è¯•å›¾æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰16æ¡æŒ‡ä»¤
for opcode in bytecode:
    execute(opcode)  # âŒ æ²¡æœ‰è€ƒè™‘PCçš„è·³è½¬ï¼
```
**ç»“æœ**: å®Œå…¨ç†è§£é”™äº†æ‰§è¡Œæµç¨‹

**åæ€**: å¿…é¡»æ‰‹åŠ¨è¿½è¸ªPCçš„è·³è½¬ï¼Œç†è§£çœŸæ­£çš„æ‰§è¡Œé¡ºåºï¼

### ç¬¬ä¸ƒæ­¥ï¼šæ‰‹åŠ¨è¿½è¸ªæ‰§è¡Œæµç¨‹

ä»PC=9å¼€å§‹ï¼ˆæŒ‡ä»¤0xA9ï¼‰ï¼Œæ‰‹åŠ¨è¿½è¸ªä¸€æ¬¡å¾ªç¯ï¼š

```
æ­¥éª¤1: PC=9  [0xA9] R0 = input[R2]         // åŠ è½½è¾“å…¥å­—ç¬¦
       PCè°ƒæ•´: -6, æ–°PC = 3

æ­¥éª¤2: PC=3  [0xA3] R0 = R0 - R2           // å‡å»ç´¢å¼•
       PCè°ƒæ•´: +2, æ–°PC = 5

æ­¥éª¤3: PC=5  [0xA5] R1 = R1 ^ R0           // âš ï¸ R1å¼‚æˆ–R0
       PCè°ƒæ•´: +1, æ–°PC = 6

æ­¥éª¤4: PC=6  [0xA6] R0 = 0xCD              // åŠ è½½å¸¸é‡
       PCè°ƒæ•´: -2, æ–°PC = 4

æ­¥éª¤5: PC=4  [0xA4] R0 = R0 ^ R1           // R0å¼‚æˆ–R1
       PCè°ƒæ•´: +7, æ–°PC = 11

æ­¥éª¤6: PC=11 [0xAB] æ¯”è¾ƒ R0 ä¸ target[R2] // éªŒè¯
       PCè°ƒæ•´: -4, æ–°PC = 7

æ­¥éª¤7: PC=7  [0xA7] R1 = R0                // âš ï¸ ä¿å­˜ç»“æœåˆ°R1ï¼
       PCè°ƒæ•´: +7, æ–°PC = 14

æ­¥éª¤8: PC=14 [0xAE] å¦‚æœç›¸ç­‰åˆ™ç»§ç»­        // æ¡ä»¶è·³è½¬
       PCè°ƒæ•´: -12, æ–°PC = 2

æ­¥éª¤9: PC=2  [0xA2] R2++                   // ç´¢å¼•é€’å¢
       PCè°ƒæ•´: +11, æ–°PC = 13

æ­¥éª¤10: PC=13 [0xAD] Flag = (R2 > 31)     // æ£€æŸ¥å®Œæˆ
       PCè°ƒæ•´: +2, æ–°PC = 15

æ­¥éª¤11: PC=15 [0xAF] å¦‚æœæœªå®Œæˆåˆ™å¾ªç¯    // å¾ªç¯æ§åˆ¶
       PCè°ƒæ•´: -6, æ–°PC = 9 (å›åˆ°æ­¥éª¤1)
```

**ç¬¬ä¸‰ä¸ªå…³é”®å‘ç°**: 
- æ°å¥½11æ¡æŒ‡ä»¤å½¢æˆä¸€ä¸ªå¾ªç¯ï¼ï¼ˆä¸é¢˜ç›®æç¤ºä¸€è‡´ï¼‰
- **æœ€å…³é”®**ï¼šæ­¥éª¤7çš„ `R1 = R0` å°†å½“å‰ç»“æœä¿å­˜åˆ°`R1`
- ä¸‹æ¬¡å¾ªç¯æ—¶ï¼Œæ­¥éª¤3çš„ `R1 = R1 ^ R0` ä¼šä½¿ç”¨è¿™ä¸ªä¿å­˜çš„å€¼
- è¿™æ„å‘³ç€æ¯ä¸ªå­—ç¬¦çš„è®¡ç®—**ä¾èµ–äºå‰ä¸€ä¸ªå­—ç¬¦**ï¼

### ç¬¬å…«æ­¥ï¼šç†è§£é“¾å¼ä¾èµ–ç®—æ³•

é‡æ–°ç†è§£å®Œæ•´ç®—æ³•ï¼ˆä¼ªä»£ç å¯¹åº”å…³ç³»ï¼‰ï¼š

```c
// å¯¹åº”VMå¯„å­˜å™¨
unsigned char a16 = 0;  // R0
unsigned char a17 = 0;  // R1  
unsigned char a18;      // R2 (å¾ªç¯ç´¢å¼•i)

for (int i = 0; i < 32; i++) {
    a18 = i;
    
    // æ­¥éª¤1-2: åŠ è½½å¹¶è°ƒæ•´
    a16 = input[i];      // 0xA9: R0 = input[R2]
    a16 = a16 - a18;     // 0xA3: R0 = R0 - R2
    
    // æ­¥éª¤3: å…³é”®å¼‚æˆ–ï¼ˆä½¿ç”¨ä¸Šæ¬¡çš„a17ï¼‰
    a17 = a16 ^ a17;     // 0xA5: R1 = R1 ^ R0
    
    // æ­¥éª¤4-5: åŠ å¯†è®¡ç®—
    a16 = 0xCD;          // 0xA6: R0 = 0xCD (å³-51)
    a16 = a16 ^ a17;     // 0xA4: R0 = R0 ^ R1
    
    // æ­¥éª¤6: éªŒè¯
    if (a16 == target[i]) {
        // æ­¥éª¤7: ä¿å­˜ç»“æœä¾›ä¸‹æ¬¡ä½¿ç”¨
        a17 = a16;       // 0xA7: R1 = R0
    } else {
        return false;
    }
}
```

**é“¾å¼ä¾èµ–çš„æœ¬è´¨**:
```
å­—ç¬¦0: a17 = 0 (åˆå§‹)
       result[0] = 0xCD ^ (input[0] - 0) ^ 0
       a17 = result[0]

å­—ç¬¦1: a17 = result[0] (æ¥è‡ªä¸Šæ¬¡)
       result[1] = 0xCD ^ (input[1] - 1) ^ result[0]
       a17 = result[1]

å­—ç¬¦2: a17 = result[1] (æ¥è‡ªä¸Šæ¬¡)
       result[2] = 0xCD ^ (input[2] - 2) ^ result[1]
       ...
```

æ¯ä¸ªå­—ç¬¦çš„åŠ å¯†ç»“æœç­‰äºç›®æ ‡å€¼ï¼š
```
result[i] = target[i]
```

### ç¬¬ä¹æ­¥ï¼šæ¨å¯¼è§£å¯†å…¬å¼

**å¯¹äºç¬¬ä¸€ä¸ªå­—ç¬¦ï¼ˆi=0ï¼‰**:
```
å·²çŸ¥ï¼ša17åˆå§‹ = 0
è¿‡ç¨‹ï¼š
  temp = input[0] - 0 = input[0]
  a17_new = temp ^ 0 = temp
  result = 0xCD ^ temp
  
è¦æ±‚ï¼šresult == target[0]
æ¨å¯¼ï¼š
  0xCD ^ temp = target[0]
  temp = 0xCD ^ target[0]
  input[0] = temp = 0xCD ^ target[0]
```

**å¯¹äºåç»­å­—ç¬¦ï¼ˆi>0ï¼‰**:
```
å·²çŸ¥ï¼ša17 = target[i-1] (ä¸Šä¸€æ¬¡çš„ç»“æœ)
è¿‡ç¨‹ï¼š
  temp = input[i] - i
  a17_new = temp ^ target[i-1]
  result = 0xCD ^ a17_new = 0xCD ^ temp ^ target[i-1]
  
è¦æ±‚ï¼šresult == target[i]
æ¨å¯¼ï¼š
  0xCD ^ temp ^ target[i-1] = target[i]
  temp = 0xCD ^ target[i] ^ target[i-1]
  input[i] = (0xCD ^ target[i] ^ target[i-1]) + i
```

### ç¬¬åæ­¥ï¼šæ­£ç¡®è§£å¯†

```python
#!/usr/bin/env python3

target = [
    0xF4, 0x0A, 0xF7, 0x64, 0x99, 0x78, 0x9E, 0x7D,
    0xEA, 0x7B, 0x9E, 0x7B, 0x9F, 0x7E, 0xEB, 0x71,
    0xE8, 0x00, 0xE8, 0x07, 0x98, 0x19, 0xF4, 0x25,
    0xF3, 0x21, 0xA4, 0x2F, 0xF4, 0x2F, 0xA6, 0x7C
]

flag = []

# ç¬¬ä¸€ä¸ªå­—ç¬¦
char0 = 0xCD ^ target[0]
flag.append(char0)
print(f"ä½ç½® 0: 0xCD ^ 0x{target[0]:02X} = '{chr(char0)}'")

# åç»­å­—ç¬¦
for i in range(1, 32):
    temp = 0xCD ^ target[i] ^ target[i-1]
    char_value = (temp + i) & 0xFF
    flag.append(char_value)
    print(f"ä½ç½® {i:2d}: (0xCD ^ 0x{target[i]:02X} ^ 0x{target[i-1]:02X}) + {i:2d} = '{chr(char_value)}'")

flag_str = ''.join(chr(c) for c in flag)
print(f"\nFLAG: UNCTF{{{flag_str}}}")
```

**è¾“å‡º**:
```
ä½ç½® 0: 0xCD ^ 0xF4 = '9'
ä½ç½®  1: (0xCD ^ 0x0A ^ 0xF4) +  1 = '4'
ä½ç½®  2: (0xCD ^ 0xF7 ^ 0x0A) +  2 = '2'
...
ä½ç½® 31: (0xCD ^ 0x7C ^ 0xA6) + 31 = '6'

FLAG: UNCTF{942a4115be2359ffd675fa6338ba23b6}
```

**æˆåŠŸï¼** ğŸ‰

### ç¬¬åä¸€æ­¥ï¼šéªŒè¯

ç¼–å†™éªŒè¯è„šæœ¬ç¡®è®¤è§£å¯†æ­£ç¡®ï¼š

```python
def verify_flag(flag):
    """æ¨¡æ‹ŸVMæ‰§è¡Œè¿‡ç¨‹éªŒè¯flag"""
    a17 = 0  # R1åˆå§‹å€¼
    
    for i in range(32):
        # æ¨¡æ‹ŸVMæŒ‡ä»¤æ‰§è¡Œ
        a16 = flag[i]              # 0xA9: åŠ è½½å­—ç¬¦
        a16 = (a16 - i) & 0xFF     # 0xA3: å‡å»ç´¢å¼•
        a17 = a16 ^ a17            # 0xA5: R1 ^= R0
        a16 = 0xCD                 # 0xA6: åŠ è½½å¸¸é‡
        a16 = a16 ^ a17            # 0xA4: R0 ^= R1
        
        # 0xAB: æ¯”è¾ƒ
        if a16 == target[i]:
            a17 = a16              # 0xA7: ä¿å­˜ç»“æœ
        else:
            print(f"éªŒè¯å¤±è´¥ï¼šä½ç½®{i}")
            return False
    
    print("âœ“ éªŒè¯æˆåŠŸï¼æ‰€æœ‰32ä¸ªå­—ç¬¦æ­£ç¡®")
    return True

verify_flag(flag)
# è¾“å‡º: âœ“ éªŒè¯æˆåŠŸï¼æ‰€æœ‰32ä¸ªå­—ç¬¦æ­£ç¡®
```

---

## æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. VMé€†å‘çš„å…³é”®æ­¥éª¤

1. **è¯†åˆ«VMç»“æ„** - æ‰¾åˆ°VMå¯¹è±¡çš„å†…å­˜å¸ƒå±€
2. **é€†å‘æŒ‡ä»¤é›†** - ç†è§£æ¯æ¡æŒ‡ä»¤çš„åŠŸèƒ½
3. **è¿½è¸ªæ‰§è¡Œæµç¨‹** - æ‰‹åŠ¨æ¨¡æ‹ŸPCè·³è½¬
4. **ç†è§£çŠ¶æ€ä¿æŒ** - æ³¨æ„å¯„å­˜å™¨åœ¨å¾ªç¯é—´çš„å€¼ä¼ é€’

### 2. é“¾å¼ä¾èµ–åŠ å¯†æœºåˆ¶

**ä¸ºä»€ä¹ˆä½¿ç”¨é“¾å¼ä¾èµ–**:
1. å¢åŠ ç ´è§£éš¾åº¦ - æ— æ³•ç‹¬ç«‹ç ´è§£å•ä¸ªå­—ç¬¦
2. é›ªå´©æ•ˆåº” - ä¸€ä¸ªå­—ç¬¦é”™è¯¯ä¼šå½±å“åç»­æ‰€æœ‰å­—ç¬¦
3. éšè—æ¨¡å¼ - çœ‹èµ·æ¥åƒç®€å•XORï¼Œå®é™…æœ‰çŠ¶æ€ä¾èµ–

**æ•°æ®æµå›¾**:
```
input[0] â†’ (å‡0) â†’ (^0) â†’ (^0xCD) â†’ target[0]
                     â†“ ä¿å­˜åˆ°a17
input[1] â†’ (å‡1) â†’ (^target[0]) â†’ (^0xCD) â†’ target[1]
                                     â†“ ä¿å­˜åˆ°a17
input[2] â†’ (å‡2) â†’ (^target[1]) â†’ (^0xCD) â†’ target[2]
                                     â†“
                                    ...
```

### 3. å…³é”®å˜é‡å¯¹åº”å…³ç³»

| IDAä¼ªä»£ç  | VMå¯„å­˜å™¨ | å®é™…å«ä¹‰ |
|----------|---------|---------|
| `*(_BYTE *)(a1 + 16)` | R0 | ç´¯åŠ å™¨/ä¸´æ—¶å¯„å­˜å™¨ |
| `*(_BYTE *)(a1 + 17)` | R1 | **çŠ¶æ€ä¿æŒå¯„å­˜å™¨** (å…³é”®!) |
| `*(_BYTE *)(a1 + 18)` | R2 | å¾ªç¯ç´¢å¼• |
| `*(_DWORD *)(a1 + 20)` | Flag | æ¯”è¾ƒç»“æœæ ‡å¿— |
| `*(_QWORD *)(a1 + 8)` | PC | ç¨‹åºè®¡æ•°å™¨ |

---

## é”™è¯¯ç»éªŒæ€»ç»“

### é”™è¯¯1: å¿½ç•¥å¯„å­˜å™¨çŠ¶æ€ä¿æŒ
```python
âŒ # å‡è®¾æ¯ä¸ªå­—ç¬¦ç‹¬ç«‹
   input[i] = (0xCD ^ target[i]) + i

âœ… # è€ƒè™‘å‰ä¸€ä¸ªå­—ç¬¦çš„å½±å“
   input[i] = (0xCD ^ target[i] ^ target[i-1]) + i
```
**æ•™è®­**: VMä¸­çš„å¯„å­˜å™¨çŠ¶æ€åœ¨å¾ªç¯é—´å¯èƒ½ä¿æŒï¼Œè¿™æ˜¯è§£é¢˜å…³é”®

### é”™è¯¯2: ä»PC=0å¼€å§‹è¿½è¸ª
```python
âŒ PC = 0  # ä»å­—èŠ‚ç å¼€å¤´
âœ… PC = 9  # ä»£ç ä¸­æ˜ç¡®è®¾ç½®ä¸º a2 + 9
```
**æ•™è®­**: ä»”ç»†è§‚å¯Ÿåˆå§‹åŒ–ä»£ç ï¼ŒPCå¯èƒ½ä¸ä»0å¼€å§‹

### é”™è¯¯3: å¿½ç•¥PCè·³è½¬çš„ç´¯ç§¯æ•ˆæœ
```python
âŒ # æŒ‰å­—èŠ‚ç é¡ºåºæ‰§è¡Œ
   for i in range(16):
       execute(bytecode[i])

âœ… # è¿½è¸ªPCè·³è½¬
   pc = 9
   while True:
       execute(bytecode[pc])
       pc += get_pc_delta(bytecode[pc])
```
**æ•™è®­**: PCè°ƒæ•´å€¼ä¼šç´¯ç§¯ï¼Œå½¢æˆå¤æ‚çš„è·³è½¬æ¨¡å¼

### é”™è¯¯4: å­—èŠ‚è¿ç®—æº¢å‡ºå¤„ç†
```python
âŒ temp = (0xCD ^ target[i] ^ target[i-1]) + i  # å¯èƒ½>255
âœ… temp = (0xCD ^ target[i] ^ target[i-1]) + i
   char_value = temp & 0xFF  # ç¡®ä¿åœ¨å­—èŠ‚èŒƒå›´å†…
```
**æ•™è®­**: Cè¯­è¨€çš„unsigned charä¼šè‡ªåŠ¨æˆªæ–­ï¼ŒPythonéœ€è¦æ‰‹åŠ¨å¤„ç†

---

## å®Œæ•´è§£å¯†è„šæœ¬

```python
#!/usr/bin/env python3
"""
VMé€†å‘ - é“¾å¼XORè§£å¯†è„šæœ¬
"""

# ç›®æ ‡æ•°ç»„ (åœ°å€ 0x6020A0)
target = [
    0xF4, 0x0A, 0xF7, 0x64, 0x99, 0x78, 0x9E, 0x7D,
    0xEA, 0x7B, 0x9E, 0x7B, 0x9F, 0x7E, 0xEB, 0x71,
    0xE8, 0x00, 0xE8, 0x07, 0x98, 0x19, 0xF4, 0x25,
    0xF3, 0x21, 0xA4, 0x2F, 0xF4, 0x2F, 0xA6, 0x7C
]

def solve_flag():
    """è§£å¯†flag"""
    flag = []
    
    # ç¬¬ä¸€ä¸ªå­—ç¬¦ (i=0)
    # å…¬å¼: input[0] = 0xCD ^ target[0]
    char0 = 0xCD ^ target[0]
    flag.append(char0)
    
    # åç»­å­—ç¬¦ (i=1..31)
    # å…¬å¼: input[i] = (0xCD ^ target[i] ^ target[i-1]) + i
    for i in range(1, 32):
        temp = 0xCD ^ target[i] ^ target[i-1]
        char_value = (temp + i) & 0xFF
        flag.append(char_value)
    
    return flag

def verify_flag(flag):
    """éªŒè¯flagæ˜¯å¦æ­£ç¡®ï¼ˆæ¨¡æ‹ŸVMæ‰§è¡Œï¼‰"""
    a17 = 0  # R1å¯„å­˜å™¨åˆå§‹å€¼
    
    for i in range(32):
        # æ¨¡æ‹ŸVMæŒ‡ä»¤
        a16 = flag[i]              # 0xA9: R0 = input[R2]
        a16 = (a16 - i) & 0xFF     # 0xA3: R0 -= R2
        a17 = a16 ^ a17            # 0xA5: R1 ^= R0
        a16 = 0xCD                 # 0xA6: R0 = 0xCD
        a16 = a16 ^ a17            # 0xA4: R0 ^= R1
        
        if a16 == target[i]:
            a17 = a16              # 0xA7: R1 = R0
        else:
            return False
    
    return True

if __name__ == "__main__":
    print("="*60)
    print("CTF VMé€†å‘ - é“¾å¼XORåŠ å¯†è§£å¯†")
    print("="*60)
    
    # è§£å¯†
    flag = solve_flag()
    flag_str = ''.join(chr(c) for c in flag)
    
    # éªŒè¯
    if verify_flag(flag):
        print("\nâœ“ éªŒè¯æˆåŠŸï¼")
        print(f"\n{'='*60}")
        print(f"FLAG: UNCTF{{{flag_str}}}")
        print(f"{'='*60}")
    else:
        print("\nâœ— éªŒè¯å¤±è´¥")
```

---

## æœ€ç»ˆç­”æ¡ˆ

### FLAG
```
UNCTF{942a4115be2359ffd675fa6338ba23b6}
```

### å…³é”®å‚æ•°

| é¡¹ç›® | å€¼ | è¯´æ˜ |
|------|-----|------|
| VMå¯¹è±¡å¤§å° | `0x28` (40å­—èŠ‚) | VMçŠ¶æ€ç»“æ„ |
| å­—èŠ‚ç åœ°å€ | `0x602080` | 16å­—èŠ‚æŒ‡ä»¤åºåˆ— |
| ç›®æ ‡å€¼åœ°å€ | `0x6020A0` | 32å­—èŠ‚æœŸæœ›å€¼ |
| èµ·å§‹PC | `9` | ä»ç¬¬9æ¡æŒ‡ä»¤å¼€å§‹ |
| å¾ªç¯é•¿åº¦ | `11æ¡æŒ‡ä»¤` | å¤„ç†æ¯ä¸ªå­—ç¬¦ |
| å¸¸é‡ | `0xCD` (å³-51) | åŠ å¯†å¸¸æ•° |
| å…³é”®å¯„å­˜å™¨ | `R1 (a17)` | ä¿æŒå‰ä¸€æ¬¡ç»“æœ |

---

## æ ¸å¿ƒç»éªŒ

1. **è¿½è¸ªPCè·³è½¬** - VMçš„æ‰§è¡Œé¡ºåºä¸æ˜¯çº¿æ€§çš„ï¼Œå¿…é¡»æ‰‹åŠ¨è¿½è¸ª
2. **å…³æ³¨çŠ¶æ€ä¿æŒ** - å¾ªç¯ä¸­å¯„å­˜å™¨å¯èƒ½ä¿æŒä¸Šæ¬¡çš„å€¼
3. **ç†è§£é“¾å¼ä¾èµ–** - æ¯ä¸ªå­—ç¬¦ä¾èµ–å‰ä¸€ä¸ªå­—ç¬¦çš„è®¡ç®—ç»“æœ
4. **æ‰‹åŠ¨æ¨¡æ‹Ÿæ‰§è¡Œ** - ç”¨çº¸ç¬”æˆ–ä»£ç æ¨¡æ‹Ÿè‡³å°‘ä¸€æ¬¡å®Œæ•´å¾ªç¯
5. **å®Œæ•´éªŒè¯** - è§£å¯†ååŠ¡å¿…ç”¨VMç®—æ³•éªŒè¯ç»“æœæ­£ç¡®æ€§
6. **å˜é‡å¯¹åº”** - å°†IDAçš„ `v8`, `v9`, `a1+16` ç­‰æ˜ å°„åˆ°æœ‰æ„ä¹‰çš„åç§°

---

**Happy Reversing! ğŸš€**