# PCAPExfil - CTF 解题报告

## 题目描述
我们拦截了一名员工机器上的可疑网络流量。他们正在浏览 `lovely-flag-stealer.com` 并发送 POST 请求。需要恢复被窃取的数据。

Flag 格式：`EdgeCTF{random_string_here}`

## 解题步骤

### 1. 分析 PCAP 文件

首先分析 `pcapExfil.pcap` 文件，发现了以下关键信息：

- 总共 24 个数据包
- 包含两个 HTTP POST 请求到 `lovely-flag-stealer.com`

### 2. 提取 POST 请求内容

**第一个 POST 请求**（数据包 #0-19）：
- 目标：`POST /upload HTTP/1.1`
- 内容：上传了一个名为 `exfil_data.zip` 的加密 ZIP 文件
- 文件大小：约 27KB
- 文件内容：包含 `flag.png.encrypted` 和 `encryptor.js`

**第二个 POST 请求**（数据包 #23）：
- 目标：`POST /api/key HTTP/1.1`
- 内容：`data=UGFzczpFZGdlRGVjcnlwdDBy`
- 这是一个 Base64 编码的字符串

### 3. 解码密钥

解码 Base64 字符串：
```python
import base64
base64.b64decode('UGFzczpFZGdlRGVjcnlwdDBy').decode()
# 结果: 'Pass:EdgeDecrypt0r'
```

得到 ZIP 文件的密码：**EdgeDecrypt0r**

### 4. 重组 TCP 流

由于 HTTP POST 请求的数据被分割成多个 TCP 数据包（数据包 #0-19），需要重组完整的 TCP 流：

- 流 ID: `61518-80`
- 总共 20 个数据包
- 重组后的完整文件大小：26834 字节

关键代码：
```python
# 合并所有 TCP 数据包
full_data = b''.join([data for _, data in packets])

# 提取 ZIP 文件内容（在 HTTP 头部之后）
file_data = full_data.split(b'Content-Type: application/zip')[1]
file_data = file_data.split(b'\r\n\r\n', 1)[1]
file_data = file_data.split(b'------WebKitFormBoundary7MA4YWxkTrZu0gW')[0]
```

### 5. 解压 ZIP 文件

使用提取的密码解压 ZIP 文件：
```python
import zipfile
z = zipfile.ZipFile('exfil_data_full.zip', 'r')
z.extractall(pwd=b'EdgeDecrypt0r')
```

得到两个文件：
1. **flag.png.encrypted** - 加密的 flag 图片
2. **encryptor.js** - Node.js 加密/解密脚本

### 6. 分析加密算法

查看 `encryptor.js` 文件，发现加密参数：

```javascript
// 加密算法：AES-256-CBC
const ENCRYPTION_KEY = crypto.createHash('sha256')
    .update('EdgeSecureKey2024!').digest(); // 32 bytes
const IV = crypto.createHash('md5')
    .update('EdgeCTFVector!').digest(); // 16 bytes
```

加密信息：
- **算法**：AES-256-CBC
- **密钥**：SHA256('EdgeSecureKey2024!')
- **初始向量 (IV)**：MD5('EdgeCTFVector!')

### 7. 解密文件

使用提供的解密脚本：
```bash
node encryptor.js decrypt flag.png.encrypted flag.png
```

成功解密得到 `flag.png` 文件！

### 8. 获取 Flag

打开 `flag.png` 图片即可看到 flag。

## 使用的工具和技术

1. **Python 脚本** - 用于解析 PCAP 文件和重组 TCP 流
2. **Base64 解码** - 解码密钥信息
3. **ZIP 文件处理** - 使用密码解压加密的 ZIP
4. **Node.js** - 使用提供的脚本解密 AES 加密文件
5. **TCP 流重组** - 将分片的 TCP 数据包重组为完整文件

## 关键知识点

1. **PCAP 文件格式**：理解 PCAP 文件的结构（全局头部 + 数据包头部 + 数据包数据）
2. **TCP 流重组**：HTTP POST 请求可能被分割成多个 TCP 数据包，需要重组
3. **HTTP 协议**：理解 multipart/form-data 格式和边界标记
4. **加密算法**：AES-256-CBC 模式的加密和解密
5. **Base64 编码**：常用于传输二进制数据

## 解题脚本

所有相关脚本已保存：
- [`analyze_pcap2.py`](analyze_pcap2.py) - 分析 PCAP 文件
- [`extract_full_file.py`](extract_full_file.py) - 重组 TCP 流并提取 ZIP 文件
- [`encryptor.js`](encryptor.js) - 加密/解密工具
- [`extract_flag.py`](extract_flag.py) - 从 PNG 中提取文本信息

## 总结

这道题目考察了：
- 网络流量分析能力
- TCP/IP 协议理解
- 文件加密和解密
- Base64 编码
- ZIP 文件密码破解

通过逐步分析网络流量，我们成功恢复了被窃取的加密数据，并使用截获的密钥进行解密，最终获得了 flag。