#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

int get_dev_mode_key(void) {
  static int dev_key = 0;
  static int initialized = 0;

  if (!initialized) {
    dev_key = rand() & 0xFFFFFF;
    initialized = 1;
  }

  return dev_key;
}

void debug_print_dev_mode_key(int key) {
  printf("\nDeveloper Mode Key: 0x%X\n", key);
}

void debug_print_api_key(void) {
  FILE *f = fopen("flag.txt", "r");
  if (f) {
    char api_access_key[64];
    fgets(api_access_key, sizeof(api_access_key), f);
    printf("\n%s", api_access_key);
    fclose(f);
  }
}

void verify_subscription(int key) {
  int license_key = get_dev_mode_key();

  if (license_key == key) {
    printf("Developer mode activated!\n");
    debug_print_api_key();
  } else {
    // Todo: Implement other subscription checks here.
  }
}

void check_premium_access(int choice) {
  int access_token;
  char input[32];

  printf("Enter access token in hex (or press Enter to skip): ");
  fgets(input, sizeof(input), stdin);

  // Empty input check, we don't have anything to do!
  // Todo: Should we return early from here if input is empty?
  if (input[0] != '\n') {
    sscanf(input, "%x", &access_token);
  }

  // Check against different access levels
  if (access_token == get_dev_mode_key()) {
    debug_print_dev_mode_key(access_token);
  } else {
    // Todo: Implement other access level checks here.
  }
}

void print_menu(void) {
  printf("=================================\n");
  printf("   Premium Content Manager      \n");
  printf("=================================\n\n");
  printf("Select an option:\n");
  printf("  1. View free content\n");
  printf("  2. Access premium content\n");
  printf("  3. Exit\n");
}

int main(void) {
  // Disable buffering
  setvbuf(stdout, NULL, _IONBF, 0);
  setvbuf(stdin, NULL, _IONBF, 0);

  srand(time(NULL));

  int choice = 0;
  int input = 0;

  print_menu();

  while (choice != 3) {
    printf("\nChoice: ");
    if (scanf("%d", &choice) != 1) {
      return 1;
    }

    switch (choice) {
      case 1:
        printf("Enter your subscription key: ");
        scanf("%d", &input);
        verify_subscription(input);
        break;

      case 2:
        printf("Enter your premium access level: ");
        scanf("%d", &input);
        check_premium_access(input);
        break;

      case 3:
        break;

      default:
        printf("Invalid option.\n");
        break;
    }
  }

  printf("Exiting.\n");
  return 0;
}
