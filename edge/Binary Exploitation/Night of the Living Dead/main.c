#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

typedef struct {
  char name[64];
  void (*attack_move)(void);
} Hero;

Hero *current_hero = NULL;

// Todo: Let's add a zombie level here, unless it exists already ?
void unlock_secret_level() {
  FILE *key = fopen("flag.txt", "r");
  if (key) {
    char api_access_key[64];
    fgets(api_access_key, sizeof(api_access_key), key);
    printf("\n [debug print] %s", api_access_key);
    fclose(key);
  }

  // Todo: Maybe add some AI features here :)
}

void normal_attack() { printf("Hero performs a basic attack! 10 damage.\n"); }

void create_hero() {
  current_hero = (Hero *)malloc(sizeof(Hero));

  printf("Enter hero name: ");
  read(STDIN_FILENO, current_hero->name, 63);
  current_hero->attack_move = normal_attack;

  printf("Hero created. Id [%p].\n", (void *)current_hero);
}

void drop_hero() {
  if (current_hero) {
    free(current_hero);
    printf("Hero dropped.\n");
  }
}

void perform_attack() {
  if (current_hero) {
    printf("Executing attack...\n");
    current_hero->attack_move();
  }
}

void train_with_dummy() {
  Hero *hero_training_dummy = (Hero *)malloc(sizeof(Hero));

  printf("Describe the training dummy stats: ");
  read(STDIN_FILENO, (char *)hero_training_dummy, sizeof(Hero));

  printf("Training dummy deployed. Id [%p].\n", (void *)hero_training_dummy);
}

int main() {
  // Disable buffering
  setvbuf(stdout, NULL, _IONBF, 0);

  int choice = 0;

  while (1) {
    printf("\n--- RPG Character Manager ---\n");
    printf("1. Create Hero\n");
    printf("2. Drop Hero\n");
    printf("3. Perform Attack\n");
    printf("4. Train with Dummy\n");
    printf("5. Exit\n");
    printf("Choice: ");

    if (scanf("%d", &choice) != 1) break;
    while (getchar() != '\n')
      ;

    switch (choice) {
      case 1:
        create_hero();
        break;
      case 2:
        drop_hero();
        break;
      case 3:
        perform_attack();
        break;
      case 4:
        train_with_dummy();
        break;
      case 5:
        exit(0);
      default:
        printf("Invalid choice.\n");
    }
  }
  return 0;
}
